<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Course Timetable Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }



        /* Responsive design for upload area */
        @media (max-width: 768px) {
            .upload-area-wide {
                min-height: 70px;
                padding: 15px 20px;
            }

            .upload-icon-wide {
                font-size: 28px;
            }

            .upload-text-wide h3 {
                font-size: 16px;
            }

            .upload-text-wide p {
                font-size: 12px;
            }

            .course-selection-section {
                gap: 15px;
            }
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .upload-section-wide {
            margin-bottom: 30px;
        }

        .course-selection-section {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .upload-area-wide {
            position: relative;
            border: 3px dashed #dee2e6;
            border-radius: 15px;
            padding: 20px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
            width: 100%;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-area-wide:hover {
            border-color: #007bff;
            background: #e3f2fd;
            transform: translateY(-2px);
        }

        .upload-area-wide.dragover {
            border-color: #007bff;
            background: #e3f2fd;
            transform: scale(1.02);
        }

        /* File loaded state */
        .upload-area-wide.file-loaded {
            border-color: #28a745;
            background: #d4edda;
            border-style: solid;
        }

        .upload-area-wide.file-loaded:hover {
            border-color: #218838;
            background: #c3e6cb;
        }

        .upload-area-wide.file-loaded .upload-icon-wide {
            color: #155724;
        }

        .upload-area-wide.file-loaded .upload-text-wide h3 {
            color: #155724;
        }

        .upload-area-wide.file-loaded .upload-text-wide p {
            color: #0f5132;
        }

        .upload-area-wide.file-loaded .upload-text-wide p strong {
            color: #155724;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.3);
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-block;
            margin: 5px 0;
        }

        .upload-content-wide {
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .upload-icon-wide {
            font-size: 36px;
            opacity: 0.7;
        }

        .upload-text-wide h3 {
            margin: 0 0 5px 0;
            color: #495057;
            font-size: 18px;
        }

        .upload-text-wide p {
            margin: 0;
            color: #6c757d;
            font-size: 14px;
        }

        .click-upload {
            color: #007bff;
            font-weight: 500;
            text-decoration: underline;
            cursor: pointer;
        }

        .click-upload:hover {
            color: #0056b3;
        }

        .clear-file {
            color: #dc3545;
            font-weight: 500;
            text-decoration: underline;
            cursor: pointer;
        }

        .clear-file:hover {
            color: #c82333;
        }



        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            display: inline-block;
        }

        .file-input-label:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .course-filter {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .course-filter input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .course-filter input:focus {
            outline: none;
            border-color: #007bff;
        }

        .course-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .course-suggestions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }
        
        .course-suggestions-title {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }
        
        .course-suggestions-close {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .course-suggestions-close:hover {
            background: #e9ecef;
            color: #495057;
        }

        .course-suggestions.show {
            display: block;
        }

        .course-suggestion-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            gap: 12px;
            border: none;
            font-size: 14px;
            color: #495057;
            width: 100%;
            text-align: left;
        }

        .course-suggestion-item:hover {
            background: #f8f9fa;
        }

        .course-suggestion-item:first-child {
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }

        .course-suggestion-item:last-child {
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
        }

        .course-suggestion-code {
            font-weight: 600;
            color: #007bff;
        }

        .course-suggestion-title {
            color: #6c757d;
            font-size: 13px;
        }

        .selected-courses {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
            min-height: 20px;
        }

        .course-bubble {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            animation: bubbleAppear 0.3s ease-out;
        }

        @keyframes bubbleAppear {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .course-bubble:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }

        .course-bubble .remove-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.2s;
            opacity: 0;
        }

        .course-bubble:hover .remove-btn {
            opacity: 1;
            background: rgba(255,255,255,0.3);
        }

        .course-bubble .remove-btn:hover {
            background: rgba(255,255,255,0.5);
            transform: scale(1.1);
        }
        
        .course-bubble.removing {
            animation: bubbleRemove 0.3s ease-in forwards;
        }
        
        @keyframes bubbleRemove {
            to {
                opacity: 0;
                transform: scale(0.8) translateY(-10px);
            }
        }

        .view-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 500;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: relative;
            width: 50px;
            height: 24px;
            background-color: #ccc;
            border-radius: 24px;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: #007bff;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .toggle-label {
            font-size: 14px;
            color: #495057;
        }

        .export-controls {
            display: flex;
            align-items: center;
        }

        .export-pdf-btn {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(220,53,69,0.3);
        }

        .export-pdf-btn:hover {
            background: linear-gradient(135deg, #c82333, #a71e2a);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220,53,69,0.4);
        }

        .export-pdf-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Preset Dropdown Styles */
        .preset-dropdown {
            position: relative;
        }

        .dropdown-container {
            position: relative;
            display: inline-block;
        }

        .dropdown-toggle {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 180px;
            justify-content: space-between;
        }

        .dropdown-toggle:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .dropdown-arrow {
            transition: transform 0.3s;
            font-size: 12px;
        }

        .dropdown-toggle.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
            margin-top: 5px;
            min-width: 280px;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-header {
            padding: 15px 20px 10px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #495057;
        }

        .clear-all-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .clear-all-btn:hover {
            background: #c82333;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            gap: 12px;
            border: none;
            font-size: 14px;
            color: #495057;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
        }

        .dropdown-item:last-child {
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
        }

        .preset-checkbox {
            display: none;
        }

        .checkmark {
            width: 18px;
            height: 18px;
            border: 2px solid #dee2e6;
            border-radius: 4px;
            position: relative;
            flex-shrink: 0;
            transition: all 0.3s;
        }

        .preset-checkbox:checked + .checkmark {
            background: #007bff;
            border-color: #007bff;
        }

        .preset-checkbox:checked + .checkmark::after {
            content: '✓';
            color: white;
            font-size: 12px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
        }

        /* Compact View Styles */
        .compact-view .schedule-cell {
            height: 18px;
            padding: 1px;
        }

        .compact-view .class-block {
            padding: 1px 3px;
            font-size: 10px;
            margin: 0;
            border-radius: 2px;
            text-align: center;
            font-weight: bold;
            line-height: 1.4;
            min-height: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .compact-view .class-info {
            display: none;
        }

        .compact-view .time-slot {
            padding: 4px;
            font-size: 10px;
        }

        .compact-view .day-header {
            padding: 6px;
            font-size: 12px;
        }

        .compact-view .time-header {
            padding: 6px;
            font-size: 12px;
        }

        .compact-view .timetable {
            font-size: 10px;
        }

        .compact-view .class-block.continuation {
            opacity: 1;
            border-top: none;
            height: 15px;
            min-height: 15px;
        }

        /* Workshop Scheduler Styles */
        .workshop-scheduler {
            margin-top: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 20px;
            border: 2px solid #dee2e6;
        }

        .workshop-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .workshop-header h2 {
            color: #495057;
            font-size: 1.8em;
            margin-bottom: 8px;
        }

        .workshop-header p {
            color: #6c757d;
            font-size: 1.1em;
        }

        .workshop-controls {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .workshop-row {
            display: flex;
            gap: 20px;
            align-items: end;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .workshop-row:last-child {
            margin-bottom: 0;
        }

        .workshop-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 180px;
        }

        .workshop-input-group label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .workshop-input-group input,
        .workshop-input-group select {
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .workshop-input-group input:focus,
        .workshop-input-group select:focus {
            outline: none;
            border-color: #007bff;
        }

        .priority-courses-section {
            flex: 1;
            min-width: 250px;
        }

        .priority-courses-section label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
            margin-bottom: 8px;
            display: block;
        }

        .priority-dropdown-container {
            position: relative;
        }

        .priority-dropdown-toggle {
            background: #6f42c1;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 220px;
            justify-content: space-between;
        }

        .priority-dropdown-toggle:hover {
            background: #5a2d91;
            transform: translateY(-2px);
        }

        .priority-dropdown-toggle.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .priority-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
            margin-top: 5px;
            max-height: 140px;
            overflow-y: auto;
            min-width: 280px;
        }

        .priority-dropdown-menu.show {
            display: block;
        }

        .priority-dropdown-header {
            padding: 12px 16px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #495057;
            font-size: 13px;
        }

        .clear-priority-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .clear-priority-btn:hover {
            background: #c82333;
        }

        .priority-course-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            gap: 12px;
            font-size: 14px;
            color: #495057;
            border: none;
            width: 100%;
            min-height: 44px;
        }

        .priority-course-item:hover {
            background: #f8f9fa;
        }

        .priority-course-checkbox {
            display: none;
        }

        .priority-course-checkbox + .checkmark {
            width: 18px;
            height: 18px;
            border: 2px solid #dee2e6;
            border-radius: 4px;
            position: relative;
            flex-shrink: 0;
            transition: all 0.3s;
            display: inline-block;
        }

        .priority-course-checkbox:checked + .checkmark {
            background: #6f42c1;
            border-color: #6f42c1;
        }

        .priority-course-checkbox:checked + .checkmark::after {
            content: '✓';
            color: white;
            font-size: 10px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
        }

        .find-workshops-btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }

        .find-workshops-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,123,255,0.4);
        }

        /* Advanced Settings Styles */
        .advanced-settings {
            margin-top: 20px;
            border: 2px solid #dee2e6;
            border-radius: 15px;
            overflow: hidden;
        }

        .advanced-toggle {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            border: none;
            padding: 15px 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
        }

        .advanced-toggle:hover {
            background: linear-gradient(135deg, #138496, #117a8b);
        }

        .advanced-toggle.active {
            background: linear-gradient(135deg, #138496, #117a8b);
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        .advanced-content {
            background: white;
            padding: 25px;
            display: none;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
        }

        .advanced-content.show {
            display: block;
        }

        .advanced-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .advanced-section h4 {
            color: #495057;
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .advanced-section-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: start;
        }

        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
        }

        .score-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .score-input-group label {
            font-size: 13px;
            font-weight: 600;
            color: #495057;
        }

        .score-input-group input {
            padding: 8px 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 13px;
            transition: border-color 0.3s;
            width: 100%;
        }

        .score-input-group input:focus {
            outline: none;
            border-color: #007bff;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-group label {
            font-weight: 600;
            color: #495057;
            cursor: pointer;
            font-size: 14px;
        }

        .time-range-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .time-range-group label {
            font-size: 13px;
            font-weight: 500;
            color: #6c757d;
            white-space: nowrap;
        }

        .time-range-group select {
            padding: 6px 8px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 13px;
            transition: border-color 0.3s;
        }

        .time-range-group select:focus {
            outline: none;
            border-color: #007bff;
        }

        .day-time-config {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .day-config {
            background: white;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }

        .day-config h5 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
        }

        .reset-defaults-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .reset-defaults-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .buffer-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .buffer-input-group input {
            width: 80px;
            padding: 8px 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 13px;
            transition: border-color 0.3s;
        }

        .buffer-input-group input:focus {
            outline: none;
            border-color: #007bff;
        }

        .buffer-input-group label {
            font-size: 13px;
            color: #6c757d;
        }

        /* Info Box Styles */
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            font-size: 10px;
            font-weight: bold;
            cursor: help;
            margin-left: 6px;
            position: relative;
            flex-shrink: 0;
        }

        .info-tooltip {
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.4;
            white-space: normal;
            width: 300px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .advanced-settings {
            margin-top: 20px;
            border: 2px solid #dee2e6;
            border-radius: 15px;
            overflow: visible;
        }

        .advanced-content .info-tooltip {
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            z-index: 10001;
        }

        .info-tooltip.adjust-position {
            bottom: auto;
            top: 125%;
        }

        .info-tooltip.adjust-position::after {
            top: -5px;
            bottom: auto;
            border-top-color: transparent;
            border-bottom-color: #2c3e50;
        }

        .info-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #2c3e50;
        }

        .info-icon:hover .info-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .workshop-input-group .info-icon {
            margin-left: 8px;
            margin-top: 2px;
        }

        .priority-courses-section .info-icon {
            margin-left: 8px;
        }

        /* Workshop Result Tooltip Styles */
        .result-item {
            padding: 15px;
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            border: 2px solid #e1bee7;
            border-radius: 12px;
            transition: transform 0.2s;
            position: relative;
            cursor: pointer;
        }

        .workshop-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.4;
            white-space: nowrap;
            max-width: 400px;
            white-space: normal;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-bottom: 8px;
        }

        .workshop-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #2c3e50;
        }

        .result-item:hover .workshop-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .conflict-list {
            margin: 8px 0;
        }

        .conflict-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .conflict-item:last-child {
            border-bottom: none;
        }

        .conflict-course {
            font-weight: 600;
        }

        .conflict-type {
            font-size: 11px;
            opacity: 0.8;
        }

        .conflict-score {
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }

        .no-conflicts {
            color: #4CAF50;
            font-weight: 600;
            text-align: center;
            font-style: italic;
        }

        .workshop-results {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .workshop-results h3 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .results-content {
            display: grid;
            gap: 15px;
        }

        .result-item {
            padding: 15px;
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            border: 2px solid #e1bee7;
            border-radius: 12px;
            transition: transform 0.2s;
        }

        .result-item:hover {
            transform: translateY(-2px);
        }

        .result-header {
            font-weight: 600;
            color: #4a148c;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .result-details {
            color: #6a1b9a;
            font-size: 14px;
            line-height: 1.4;
        }

        .conflict-score {
            background: #4a148c;
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }

        .scoring-explanation {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            margin-top: 20px;
        }

        .scoring-explanation h4 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .scoring-details {
            color: #6c757d;
            line-height: 1.6;
        }

        .scoring-details p {
            margin-bottom: 12px;
        }

        .scoring-details ul {
            margin: 15px 0;
            padding-left: 20px;
        }

        .scoring-details li {
            margin-bottom: 8px;
        }

        .scoring-details strong {
            color: #495057;
        }

        .scoring-details em {
            font-style: italic;
            color: #495057;
        }

        .compact-view .class-block.continuation {
            opacity: 1;
            border-top: none;
        }

        .legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 15px;
            background: white;
            border: 2px solid #e9ecef;
            font-weight: 500;
        }

        .color-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        .timetable-container {
            padding: 30px;
            overflow-x: auto;
        }

        .timetable {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .time-header {
            background: #2c3e50;
            color: white;
            font-weight: bold;
            text-align: center;
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .day-header {
            background: #34495e;
            color: white;
            font-weight: bold;
            text-align: center;
            padding: 15px;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            min-width: 120px;
        }

        .time-slot {
            background: #ecf0f1;
            font-weight: 500;
            text-align: center;
            padding: 10px;
            border-right: 2px solid #bdc3c7;
            white-space: nowrap;
            width: 100px;
        }

        .schedule-cell {
            border: 1px solid #e9ecef;
            height: 35px;
            position: relative;
            padding: 4px;
            vertical-align: top;
            width: 140px;
        }

        .class-block {
            background: #3498db;
            color: white;
            padding: 3px 6px;
            border-radius: 6px;
            margin: 1px 0;
            font-size: 10px;
            font-weight: 500;
            line-height: 1.1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .class-block:hover {
            transform: scale(1.05);
            z-index: 5;
            position: relative;
        }

        .class-block.lecture {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .class-block.tutorial,
        .class-block.lab,
        .class-block.seminar,
        .class-block.practicum {
            background: linear-gradient(135deg, #f1c40f, #f39c12);
            color: #2c3e50;
        }

        .class-block.continuation {
            opacity: 0.7;
            border-top: 2px dashed rgba(255,255,255,0.5);
        }

        .class-info {
            display: block;
            font-size: 9px;
            opacity: 0.95;
            line-height: 1.1;
        }

        .no-data {
            text-align: center;
            padding: 60px;
            color: #7f8c8d;
            font-size: 18px;
        }

        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .csv-preview {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow: auto;
            font-family: monospace;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .upload-section {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .course-filter {
                min-width: auto;
            }
            
            .course-suggestions {
                max-height: 250px;
            }
            
            .selected-courses {
                justify-content: center;
            }
            
            .course-bubble {
                font-size: 13px;
                padding: 6px 10px;
            }
            
            .preset-dropdown {
                align-self: center;
            }
            
            .dropdown-toggle {
                width: 100%;
                max-width: 280px;
            }
            
            .view-toggle {
                justify-content: center;
            }
            
            .export-controls {
                justify-content: center;
                margin-top: 10px;
            }
            
            .export-pdf-btn {
                width: 100%;
                max-width: 280px;
            }
            
            .legend {
                justify-content: center;
            }
            
            .day-header {
                writing-mode: horizontal-tb;
                text-orientation: initial;
                min-width: auto;
            }

            .workshop-row {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .workshop-input-group {
                min-width: auto;
            }

            .priority-courses-section {
                min-width: auto;
            }

            .priority-dropdown-toggle {
                min-width: auto;
                width: 100%;
            }

            .find-workshops-btn {
                width: 100%;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📚 Course Timetable Generator</h1>
            <p>Upload your CSV course data and create a beautiful visual timetable</p>
        </div>



        <div class="controls">
            <!-- Upload Section - Wider and Thinner -->
            <div class="upload-section-wide">
                <div class="upload-area-wide" id="uploadArea">
                    <div class="upload-content-wide">
                        <div class="upload-icon-wide">📁</div>
                        <div class="upload-text-wide">
                            <h3>Upload CSV File</h3>
                            <p>Drag and drop your CSV file here, or <span class="click-upload">click to browse</span></p>
                        </div>
                    </div>
                    <input type="file" id="csvFile" class="file-input" accept=".csv" />
                </div>
            </div>

            <!-- Course Selection Section -->
            <div class="course-selection-section">
                <div class="course-filter">
                    <input type="text" id="courseFilter" placeholder="Search for courses..." />
                    <div class="course-suggestions" id="courseSuggestions">
                        <!-- Course suggestions will be populated here -->
                    </div>
                </div>
                <div class="preset-dropdown">
                    <div class="dropdown-container">
                        <button type="button" class="dropdown-toggle" id="presetToggle">
                            📚 Course Presets <span class="dropdown-arrow">▼</span>
                        </button>
                        <div class="dropdown-menu" id="presetMenu">
                            <div class="dropdown-header">
                                <span>Select Course Groups:</span>
                                <button type="button" class="clear-all-btn" id="clearPresets">Clear All</button>
                            </div>
                            <div class="dropdown-item" style="flex-direction: column; align-items: stretch; gap: 8px;">
                                <label style="font-weight: 600;">Faculty</label>
                                <select id="facultySelect" style="padding: 8px 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;">
                                    <option value="">Select a faculty...</option>
                                </select>
                            </div>
                            <div class="dropdown-item" style="flex-direction: column; align-items: stretch; gap: 8px;">
                                <label style="font-weight: 600;">Program</label>
                                <select id="programSelect" disabled style="padding: 8px 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;">
                                    <option value="">Select a program...</option>
                                </select>
                            </div>
                            <div class="dropdown-item" style="flex-direction: column; align-items: stretch; gap: 8px;">
                                <label style="font-weight: 600;">Year</label>
                                <select id="yearSelect" disabled style="padding: 8px 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;">
                                    <option value="">Select a year...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="view-toggle">
                    <label class="toggle-switch">
                        <input type="checkbox" id="compactToggle">
                        <span class="slider"></span>
                        <span class="toggle-label">Compact View</span>
                    </label>
                </div>
                <div class="export-controls" style="display: none;">
                    <button type="button" class="export-pdf-btn" id="exportPdf">📄 Export as PDF</button>
                </div>
            </div>

            <div class="selected-courses" id="selectedCourses">
                <!-- Selected course bubbles will appear here -->
                <div id="noCoursesMessage" style="display: none; color: #6c757d; font-style: italic; text-align: center; width: 100%;">
                    No courses selected. Search for courses above or use the presets to get started.
                </div>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="color-dot" style="background: linear-gradient(135deg, #e74c3c, #c0392b);"></div>
                    <span>Lectures</span>
                </div>
                <div class="legend-item">
                    <div class="color-dot" style="background: linear-gradient(135deg, #f1c40f, #f39c12);"></div>
                    <span>All Others (Tutorials, Labs, Seminars, etc.)</span>
                </div>
            </div>
        </div>

        <div id="status"></div>
        
        <div class="timetable-container">
            <div class="no-data" id="noData">
                <h3>🎯 Ready to Create Your Timetable!</h3>
                <p>Upload a CSV file with your course data to get started.</p>
                <br>
                <p><strong>Expected CSV format (your scheduling system):</strong></p>
                <p>Headers: Subject, Course Number, Sec, Day, BTime, Duration, Room, Faculty Name</p>
                <p><em>The tool will automatically combine Subject + Course Number (e.g., MATH + 1010U = MATH1010U)</em></p>
            </div>
        </div>

        <div class="workshop-scheduler" id="workshopScheduler" style="display: none;">
            <div class="workshop-header">
                <h2>🛠️ Workshop Scheduler</h2>
                <p>Find optimal times to schedule workshops with minimal course conflicts</p>
            </div>
            
            <div class="workshop-controls">
                <div class="workshop-row">
                    <div class="priority-courses-section">
                        <label>Priority Courses (higher avoidance):
                            <span class="info-icon">i
                                <div class="info-tooltip">Courses selected here will have much higher conflict penalties, making the algorithm strongly avoid scheduling workshops during these times. Use for core courses or high-enrollment classes.</div>
                            </span>
                        </label>
                        <div class="priority-dropdown-container">
                            <button type="button" class="priority-dropdown-toggle" id="priorityToggle">
                                📍 Select Priority Courses <span class="dropdown-arrow">▼</span>
                            </button>
                            <div class="priority-dropdown-menu" id="priorityMenu">
                                <div class="priority-dropdown-header">
                                    <span>Select courses to avoid conflicts with:</span>
                                    <button type="button" class="clear-priority-btn" id="clearPriority">Clear All</button>
                                </div>
                                <div id="priorityCoursesList">
                                    <!-- Dynamically populated -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="workshop-input-group">
                        <label for="workshopDuration">Workshop Duration (minutes):
                            <span class="info-icon">i
                                <div class="info-tooltip">Length of your workshop in minutes. The algorithm will find time slots that can accommodate this full duration with minimal conflicts across all time slots.</div>
                            </span>
                        </label>
                        <input type="number" id="workshopDuration" min="30" max="300" step="30" value="60" />
                    </div>
                </div>
                
                <div class="workshop-row">
                    <div class="workshop-input-group">
                        <label for="earliestTime">Earliest Start Time:
                            <span class="info-icon">i
                                <div class="info-tooltip">The earliest time workshops can start. Use this to respect student schedules and avoid times when attendance would be poor.</div>
                            </span>
                        </label>
                        <select id="earliestTime">
                            <option value="08:00">8:00 AM</option>
                            <option value="08:30">8:30 AM</option>
                            <option value="09:00">9:00 AM</option>
                            <option value="09:30">9:30 AM</option>
                            <option value="10:00">10:00 AM</option>
                            <option value="10:30">10:30 AM</option>
                            <option value="11:00">11:00 AM</option>
                            <option value="11:30">11:30 AM</option>
                            <option value="12:00">12:00 PM</option>
                            <option value="12:30">12:30 PM</option>
                            <option value="13:00">1:00 PM</option>
                            <option value="13:30">1:30 PM</option>
                            <option value="14:00">2:00 PM</option>
                            <option value="14:30">2:30 PM</option>
                            <option value="15:00">3:00 PM</option>
                            <option value="15:30">3:30 PM</option>
                            <option value="16:00">4:00 PM</option>
                            <option value="16:30">4:30 PM</option>
                            <option value="17:00">5:00 PM</option>
                            <option value="17:30">5:30 PM</option>
                            <option value="18:00">6:00 PM</option>
                        </select>
                    </div>
                    
                    <div class="workshop-input-group">
                        <label for="latestTime">Latest End Time:
                            <span class="info-icon">i
                                <div class="info-tooltip">The latest time workshops can start. Note that your workshop must fit entirely before this time (duration is considered automatically).</div>
                            </span>
                        </label>
                        <select id="latestTime">
                            <option value="10:00">10:00 AM</option>
                            <option value="10:30">10:30 AM</option>
                            <option value="11:00">11:00 AM</option>
                            <option value="11:30">11:30 AM</option>
                            <option value="12:00">12:00 PM</option>
                            <option value="12:30">12:30 PM</option>
                            <option value="13:00">1:00 PM</option>
                            <option value="13:30">1:30 PM</option>
                            <option value="14:00">2:00 PM</option>
                            <option value="14:30">2:30 PM</option>
                            <option value="15:00">3:00 PM</option>
                            <option value="15:30">3:30 PM</option>
                            <option value="16:00">4:00 PM</option>
                            <option value="16:30">4:30 PM</option>
                            <option value="17:00">5:00 PM</option>
                            <option value="17:30">5:30 PM</option>
                            <option value="18:00">6:00 PM</option>
                            <option value="18:30">6:30 PM</option>
                            <option value="19:00">7:00 PM</option>
                            <option value="19:30">7:30 PM</option>
                            <option value="20:00" selected>8:00 PM</option>
                        </select>
                    </div>
                    
                    <div class="workshop-input-group">
                        <button type="button" class="find-workshops-btn" id="findWorkshops">🔍 Find Best Workshop Times</button>
                    </div>
                </div>
                
                <div class="advanced-settings">
                    <button type="button" class="advanced-toggle" id="advancedToggle">
                        ⚙️ Advanced Settings <span class="dropdown-arrow">▼</span>
                    </button>
                    <div class="advanced-content" id="advancedContent">
                        <!-- Conflict Score Settings -->
                        <div class="advanced-section">
                            <h4>📊 Conflict Score Values
                                <span class="info-icon">i
                                    <div class="info-tooltip">Lower scores are better. These values are added together for each conflicting course during your workshop time. Customize these to reflect the importance of avoiding different types of conflicts.</div>
                                </span>
                            </h4>
                            <div class="score-grid">
                                <div class="score-input-group">
                                    <label>Non-priority Tutorial/Lab/Other:</label>
                                    <input type="number" id="scoreNonPriorityOther" min="0" max="100" value="1" />
                                </div>
                                <div class="score-input-group">
                                    <label>Non-priority Lecture:</label>
                                    <input type="number" id="scoreNonPriorityLecture" min="0" max="100" value="5" />
                                </div>
                                <div class="score-input-group">
                                    <label>Priority Tutorial/Lab/Other:</label>
                                    <input type="number" id="scorePriorityOther" min="0" max="100" value="3" />
                                </div>
                                <div class="score-input-group">
                                    <label>Priority Lecture:</label>
                                    <input type="number" id="scorePriorityLecture" min="0" max="100" value="20" />
                                </div>
                            </div>
                        </div>

                        <!-- Lunch Avoidance -->
                        <div class="advanced-section">
                            <h4>🍽️ Lunch Time Avoidance
                                <span class="info-icon">i
                                    <div class="info-tooltip">Adds penalty points for workshop times that overlap with typical lunch hours. Even online students often prefer to maintain regular meal schedules.</div>
                                </span>
                            </h4>
                            <div class="checkbox-group">
                                <input type="checkbox" id="avoidLunch">
                                <label for="avoidLunch">Avoid scheduling during lunch hours</label>
                            </div>
                            <div class="time-range-group">
                                <label>Lunch period:</label>
                                <select id="lunchStartTime">
                                    <option value="11:30">11:30 AM</option>
                                    <option value="12:00" selected>12:00 PM</option>
                                    <option value="12:30">12:30 PM</option>
                                </select>
                                <label>to</label>
                                <select id="lunchEndTime">
                                    <option value="13:00">1:00 PM</option>
                                    <option value="13:30" selected>1:30 PM</option>
                                    <option value="14:00">2:00 PM</option>
                                </select>
                                <label>Lunch penalty score:</label>
                                <input type="number" id="lunchPenalty" min="0" max="1000" value="50" style="width: 80px; padding: 6px 8px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 13px;" />
                            </div>
                        </div>

                        <!-- Per-Day Time Settings -->
                        <div class="advanced-section">
                            <h4>📅 Day-Specific Time Ranges
                                <span class="info-icon">i
                                    <div class="info-tooltip">Set different available time windows for each day of the week. Useful if certain days have different course loads or student availability patterns.</div>
                                </span>
                            </h4>
                            <div class="checkbox-group">
                                <input type="checkbox" id="enableDaySpecific">
                                <label for="enableDaySpecific">Use different time ranges for each day</label>
                            </div>
                            <div class="day-time-config" id="dayTimeConfig" style="display: none;">
                                <div class="day-config">
                                    <h5>Monday</h5>
                                    <div class="time-range-group">
                                        <select id="mondayStart">
                                            <!-- Options will be populated by JS -->
                                        </select>
                                        <label>to</label>
                                        <select id="mondayEnd">
                                            <!-- Options will be populated by JS -->
                                        </select>
                                    </div>
                                </div>
                                <div class="day-config">
                                    <h5>Tuesday</h5>
                                    <div class="time-range-group">
                                        <select id="tuesdayStart"></select>
                                        <label>to</label>
                                        <select id="tuesdayEnd"></select>
                                    </div>
                                </div>
                                <div class="day-config">
                                    <h5>Wednesday</h5>
                                    <div class="time-range-group">
                                        <select id="wednesdayStart"></select>
                                        <label>to</label>
                                        <select id="wednesdayEnd"></select>
                                    </div>
                                </div>
                                <div class="day-config">
                                    <h5>Thursday</h5>
                                    <div class="time-range-group">
                                        <select id="thursdayStart"></select>
                                        <label>to</label>
                                        <select id="thursdayEnd"></select>
                                    </div>
                                </div>
                                <div class="day-config">
                                    <h5>Friday</h5>
                                    <div class="time-range-group">
                                        <select id="fridayStart"></select>
                                        <label>to</label>
                                        <select id="fridayEnd"></select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Extended Conflict Buffer -->
                        <div class="advanced-section">
                            <h4>🛡️ Conflict Buffers
                                <span class="info-icon">i
                                    <div class="info-tooltip">Adds time buffers before and after existing courses to prevent back-to-back scheduling. Helps students transition between activities and reduces stress from tight schedules.</div>
                                </span>
                            </h4>
                            <p style="color: #6c757d; font-size: 13px; margin-bottom: 15px;">Add buffer time before/after existing classes to avoid back-to-back scheduling conflicts.</p>
                            <div class="checkbox-group">
                                <input type="checkbox" id="enableBuffer">
                                <label for="enableBuffer">Enable conflict buffers</label>
                            </div>
                            <div class="advanced-section-grid">
                                <div class="buffer-input-group">
                                    <label>Before lectures:</label>
                                    <input type="number" id="bufferBeforeLecture" min="0" max="120" step="30" value="0" />
                                    <label>minutes</label>
                                </div>
                                <div class="buffer-input-group">
                                    <label>After lectures:</label>
                                    <input type="number" id="bufferAfterLecture" min="0" max="120" step="30" value="0" />
                                    <label>minutes</label>
                                </div>
                                <div class="buffer-input-group">
                                    <label>Before other classes:</label>
                                    <input type="number" id="bufferBeforeOther" min="0" max="120" step="30" value="0" />
                                    <label>minutes</label>
                                </div>
                                <div class="buffer-input-group">
                                    <label>After other classes:</label>
                                    <input type="number" id="bufferAfterOther" min="0" max="120" step="30" value="0" />
                                    <label>minutes</label>
                                </div>
                            </div>
                        </div>

                        <!-- Enrollment-Based Weighting -->
                        <div class="advanced-section">
                            <h4>👥 Enrollment-Based Scoring
                                <span class="info-icon">i
                                    <div class="info-tooltip">Multiplies conflict scores by actual enrollment numbers from your CSV data. Higher enrollment courses get higher penalties, helping minimize impact on the most students.</div>
                                </span>
                            </h4>
                            <p style="color: #6c757d; font-size: 13px; margin-bottom: 15px;">Weight conflicts based on actual student enrollment from CSV data to minimize impact on the most students.</p>
                            <div class="checkbox-group">
                                <input type="checkbox" id="enableEnrollmentWeighting">
                                <label for="enableEnrollmentWeighting">Apply enrollment-based weighting</label>
                            </div>
                            <div class="advanced-section-grid">
                                <div class="score-input-group">
                                    <label>Fallback enrollment (1st year courses):</label>
                                    <input type="number" id="baseEnrollmentFirst" min="10" max="500" value="200" />
                                </div>
                                <div class="score-input-group">
                                    <label>Fallback enrollment (2nd+ year courses):</label>
                                    <input type="number" id="baseEnrollmentUpper" min="10" max="500" value="100" />
                                </div>
                                <div class="score-input-group">
                                    <label>Lecture enrollment multiplier (fallback):</label>
                                    <input type="number" id="lectureEnrollmentMultiplier" min="0.1" max="5" step="0.1" value="1.0" />
                                </div>
                                <div class="score-input-group">
                                    <label>Tutorial/Lab enrollment fraction (fallback):</label>
                                    <input type="number" id="tutorialEnrollmentFraction" min="0.1" max="1" step="0.1" value="0.3" />
                                </div>
                            </div>
                        </div>

                        <!-- Results Display Settings -->
                        <div class="advanced-section">
                            <h4>📈 Results Display</h4>
                            <div class="score-input-group">
                                <label>Number of recommended time slots:</label>
                                <input type="number" id="numRecommendations" min="1" max="50" value="10" />
                            </div>
                        </div>

                        <button type="button" class="reset-defaults-btn" id="resetDefaults">
                            🔄 Reset to Default Settings
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="workshop-results" id="workshopResults" style="display: none;">
                <h3>📊 Recommended Workshop Times</h3>
                <div style="margin: 10px 0 15px 0;">
                    <button type="button" class="find-workshops-btn" id="downloadCsvRecommendations" style="display: none;">⬇️ Download Recommended Times (CSV)</button>
                </div>
                <div class="results-content" id="resultsContent">
                    <!-- Results will be populated here -->
                </div>
            </div>
            
            <div class="scoring-explanation" id="scoringExplanation" style="display: none;">
                <h4>🧮 How Conflict Scores Are Calculated</h4>
                <div class="scoring-details">
                    <p><strong>Lower scores = better workshop times!</strong> Each course running during a potential workshop time adds points:</p>
                    <ul>
                        <li><span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;">+1</span> <strong>Non-priority Tutorial/Lab/Other</strong></li>
                        <li><span style="background: #ffc107; color: #212529; padding: 2px 6px; border-radius: 4px; font-size: 11px;">+5</span> <strong>Non-priority Lecture</strong></li>
                        <li><span style="background: #fd7e14; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;">+3</span> <strong>Priority Tutorial/Lab/Other</strong></li>
                        <li><span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;">+20</span> <strong>Priority Lecture</strong></li>
                    </ul>
                    <p><em><strong>Priority courses</strong> are those you've specifically selected above. The algorithm finds workshop times that minimize total conflict points across your entire workshop duration.</em></p>
                    <p><em><strong>Example:</strong> A time slot with 2 non-priority tutorials (2 points) + 1 priority lecture (20 points) = 22 total points.</em></p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js?v=2"></script>
    <script>
        let courseData = [];
        let allCourses = [];

        // Time slots (8 AM to 8 PM) - 15 minute intervals
        const timeSlots = [];
        for (let hour = 8; hour <= 20; hour++) {
            timeSlots.push(`${hour.toString().padStart(2, '0')}:00`);
            timeSlots.push(`${hour.toString().padStart(2, '0')}:15`);
            timeSlots.push(`${hour.toString().padStart(2, '0')}:30`);
            timeSlots.push(`${hour.toString().padStart(2, '0')}:45`);
        }

        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];



        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');
        const csvFileInput = document.getElementById('csvFile');

        uploadArea.addEventListener('click', () => csvFileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'text/csv') {
                csvFileInput.files = files;
                handleFileUpload();
            }
        });

        // Function to update upload area appearance when file is loaded
        function updateUploadAreaAppearance(fileName) {
            const uploadContent = uploadArea.querySelector('.upload-content-wide');
            if (fileName) {
                uploadArea.classList.add('file-loaded');
                uploadContent.innerHTML = `
                    <div class="upload-icon-wide">📄</div>
                    <div class="upload-text-wide">
                        <h3>CSV File Loaded</h3>
                        <p><strong>${fileName}</strong></p>
                        <p><span class="click-upload">Click to replace file</span> or <span class="clear-file">clear file</span></p>
                    </div>
                `;
                
                // Add event listener to clear button
                const clearBtn = uploadContent.querySelector('.clear-file');
                if (clearBtn) {
                    clearBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        clearUploadedFile();
                    });
                }
            } else {
                uploadArea.classList.remove('file-loaded');
                uploadContent.innerHTML = `
                    <div class="upload-icon-wide">📁</div>
                    <div class="upload-text-wide">
                        <h3>Upload CSV File</h3>
                        <p>Drag and drop your CSV file here, or <span class="click-upload">click to browse</span></p>
                    </div>
                `;
            }
        }

        // Function to clear the uploaded file
        function clearUploadedFile() {
            csvFileInput.value = '';
            courseData = [];
            allCourses = [];
            selectedCourses.clear();
            updateUploadAreaAppearance(null);
            renderSelectedCourseBubbles();
            
            // Clear the timetable
            const container = document.querySelector('.timetable-container');
            if (container) {
                container.innerHTML = `
                    <div class="no-data" id="noData">
                        <h3>🎯 Ready to Create Your Timetable!</h3>
                        <p>Upload a CSV file with your course data to get started.</p>
                        <br>
                        <p><strong>Expected CSV format (your scheduling system):</strong></p>
                        <p>Headers: Subject, Course Number, Sec, Day, BTime, Duration, Room, Faculty Name</p>
                        <p><em>The tool will automatically combine Subject + Course Number (e.g., MATH + 1010U = MATH1010U)</em></p>
                    </div>
                `;
            }
            
            // Hide workshop scheduler
            const workshopScheduler = document.getElementById('workshopScheduler');
            if (workshopScheduler) {
                workshopScheduler.style.display = 'none';
            }
            
            showStatus('File cleared. Ready for new upload.');
        }

        document.getElementById('csvFile').addEventListener('change', handleFileUpload);
        document.getElementById('courseFilter').addEventListener('input', filterAndRenderTimetable);
        document.getElementById('compactToggle').addEventListener('change', handleCompactToggle);
        document.getElementById('presetToggle').addEventListener('click', handlePresetToggle);
        document.getElementById('clearPresets').addEventListener('click', clearAllPresets);
        document.getElementById('facultySelect').addEventListener('change', handleFacultyChange);
        document.getElementById('programSelect').addEventListener('change', handleProgramChange);
        document.getElementById('yearSelect').addEventListener('change', handleYearChange);
        document.getElementById('priorityToggle').addEventListener('click', handlePriorityToggle);
        document.getElementById('clearPriority').addEventListener('click', clearAllPriority);
        document.getElementById('findWorkshops').addEventListener('click', findOptimalWorkshopTimes);
        document.getElementById('downloadCsvRecommendations').addEventListener('click', downloadRecommendationsCsv);
        document.getElementById('exportPdf').addEventListener('click', exportTimetablePDF);
        document.getElementById('advancedToggle').addEventListener('click', handleAdvancedToggle);
        document.getElementById('enableDaySpecific').addEventListener('change', handleDaySpecificToggle);
        document.getElementById('resetDefaults').addEventListener('click', resetToDefaults);
        
        // Course search and selection functionality
        document.getElementById('courseFilter').addEventListener('input', handleCourseSearch);
        document.getElementById('courseFilter').addEventListener('focus', showCourseSuggestions);
        document.getElementById('courseFilter').addEventListener('blur', hideCourseSuggestions);
        document.getElementById('courseFilter').addEventListener('keydown', handleCourseSearchKeydown);

        // Initialize advanced settings
        initializeAdvancedSettings();
        initializeTooltipPositioning();
        
        // Course search and selection state
        let selectedCourses = new Set();
        let courseSuggestions = [];
        
        // Initialize the UI
        renderSelectedCourseBubbles();

        // Store all ranked opportunities for CSV export
        let lastRankedOpportunities = [];

        // Initialize cascading preset selects (moved to after presets are defined)

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('presetMenu');
            const toggle = document.getElementById('presetToggle');
            const priorityDropdown = document.getElementById('priorityMenu');
            const priorityToggle = document.getElementById('priorityToggle');
            const courseSuggestions = document.getElementById('courseSuggestions');
            const courseFilter = document.getElementById('courseFilter');
            
            if (!toggle.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.remove('show');
                toggle.classList.remove('active');
            }
            
            if (!priorityToggle.contains(event.target) && !priorityDropdown.contains(event.target)) {
                priorityDropdown.classList.remove('show');
                priorityToggle.classList.remove('active');
            }
            
            if (!courseFilter.contains(event.target) && !courseSuggestions.contains(event.target)) {
                hideCourseSuggestions();
            }
        });

        // Define faculty -> program -> year presets
        const programPresets = {
            FSc: {
                'Computer Science': {
                    '1st year': [
                        'CSCI1030U', 'CSCI1060U', 'CSCI1061U', 'CSCI2050U', 'MATH1020U',
                        'PHY1020U', 'CSCI2050U', 'CSCI1062U', 'CSCI1063U', 'MATH1000U',
                        'MATH1010U', 'PHY1010U', 'PHY1030U'
                    ],
                    '2nd year': [
                        'CSCI2000U', 'CSCI2010U', 'CSCI2020U', 'CSCI2040U', 'CSCI2072U',
                        'CSCI2110U', 'MATH2050U', 'STAT2010U'
                    ]
                },
                'General Science': {
                    '1st year': [
                        'BIOL1000U', 'BIOL1010U', 'BIOL1020U', 'CHEM1010U', 'CHEM1020U',
                        'CSCI1040U', 'MATH1000U', 'MATH1010U', 'MATH1020U', 'PHY1030U',
                        'PHY1010U', 'PHY1020U'
                    ]
                }
            },
            FEAS: {
                'Pre-Engineering': {
                    'Pre-Engineering': [
                        'COMM1050U', 'CHEM0900U', 'ENGR1015U', 'MATH0900U', 'PHY0900U'
                    ]
                },
                'General Engineering': {
                    '1st year': [
                        'COMM1050U', 'ENGR1015U', 'MATH1010U', 'MATH1850U', 'PHY1010U',
                        'CHEM1800U', 'ENGR1025U', 'ENGR1200U', 'MATH1020U', 'PHY1020U',
                        'SSCI1470U'
                    ]
                }
            },
            FBIT: {
                'General Business': {
                    '1st year': [
                        'BUSI1030U', 'BUSI1130U', 'BUSI1520U', 'BUSI1600U', 'BUSI1700U',
                        'BUSI1915U', 'BUSI2000U', 'BUSI2311U', 'ECON2010U', 'ECON2020U',
                        'INFR1101U', 'XBIT1500U'
                    ]
                }
            },
            FHS: {
                'Health Science': {},
                'Medical Laboratory Science': {
                    '1st Year': [
                        'BIOL1010U', 'CHEM1010U', 'HLSC1200U', 'HLSC1701U', 'CHEM1020U',
                        'HLSC1201U', 'MLSC1110U', 'MATH1880U'
                    ],
                    '2nd Year': [
                        'HLSC2460U', 'HLSC3800U', 'MLSC1010U', 'MLSC2130U', 'HLSC2461U',
                        'HLSC3910U', 'MLSC2111U', 'MLSC2121U', 'MLSC2131U'
                    ],
                    '3rd Year': [
                        'MLSC3111U', 'MLSC3121U', 'MLSC3131U', 'MLSC3200U', 'MLSC3230U',
                        'MLSC3141U', 'MLSC3210U', 'MLSC3220U', 'MLSC3231U', 'MLSC3300U'
                    ],
                    '4th Year': [
                        'HLSC4820U', 'MLSC4111U', 'MLSC4121U', 'MLSC4131U', 'MLSC4210U',
                        'MLSC4220U', 'MLSC4231U', 'MLSC4400U', 'MLSC4112U', 'MLSC4122U',
                        'MLSC4132U', 'MLSC4211U', 'MLSC4221U', 'MLSC4232U', 'MLSC4401U'
                    ]
                },
                'Nursing': {
                    '1st year': [
                        'HLSC1200U', 'HLSC1701U', 'NURS1003U', 'NURS1100U', 'NURS1420U',
                        'HLSC1201U', 'NURS1503U', 'NURS1700U', 'NURS2320U', 'SOCI1000U'
                    ],
                    '2nd year': [
                        'HLSC2460U', 'NURS2420U', 'NURS2810U', 'BIOL2830U', 'HLSC2461U',
                        'HLSC2820U', 'NURS2700U', 'NURS2701U'
                    ]
                },
                'Kinesiology': {
                    '1st year': [
                        'KINE1000U', 'KINE1010U', 'KINE1020U', 'KINE1030U', 'KINE1100U',
                        'KINE1110U', 'KINE1120U', 'KINE1130U', 'BIOL1010U', 'BIOL1020U',
                        'BIOL1011U', 'BIOL1840U', 'CHEM1010U', 'CHEM1020U', 'PSYC1000U',
                        'SSCI1300U', 'SOCI1000U', 'COMM1100U'
                    ]
                }
            },
            FSSH: {},
            FFEd: {}
        };

        // Display labels for faculties
        const facultyLabels = {
            FSc: 'Faculty of Science',
            FSSH: 'Faculty of Social Science and Humanities',
            FEAS: 'Faculty of Engineering and Applied Science',
            FHS: 'Faculty of Health Science',
            FFEd: 'Frazer Faculty of Education',
            FBIT: 'Faculty of Business and Information Technology'
        };

        // Ensure faculty list is populated after presets are defined
        if (typeof initializePresetSelectors === 'function') {
            initializePresetSelectors();
        }

        function handlePresetToggle() {
            const dropdown = document.getElementById('presetMenu');
            const toggle = document.getElementById('presetToggle');
            
            dropdown.classList.toggle('show');
            toggle.classList.toggle('active');

            // Lazy-populate faculties if not yet populated
            const facultySelect = document.getElementById('facultySelect');
            if (facultySelect && facultySelect.options.length <= 1 && typeof initializePresetSelectors === 'function') {
                initializePresetSelectors();
            }
        }

        function clearAllPresets() {
            // Reset cascading selects
            const faculty = document.getElementById('facultySelect');
            const program = document.getElementById('programSelect');
            const year = document.getElementById('yearSelect');
            if (faculty) faculty.value = '';
            if (program) {
                program.innerHTML = '<option value="">Select a program...</option>';
                program.disabled = true;
            }
            if (year) {
                year.innerHTML = '<option value="">Select a year...</option>';
                year.disabled = true;
            }

            // Clear the course filter
            document.getElementById('courseFilter').value = '';
            
            // Clear selected courses
            selectedCourses.clear();
            renderSelectedCourseBubbles();
            
            // Update the timetable
            filterAndRenderTimetable();
        }

        function initializePresetSelectors() {
            const facultySelect = document.getElementById('facultySelect');
            const programSelect = document.getElementById('programSelect');
            const yearSelect = document.getElementById('yearSelect');
            
            // Populate faculty options
            Object.keys(programPresets).forEach(fac => {
                const label = facultyLabels[fac] || fac;
                const opt = new Option(label, fac);
                facultySelect.appendChild(opt);
            });
            
            // Ensure program/year are reset
            programSelect.disabled = true;
            yearSelect.disabled = true;
        }

        function handleFacultyChange() {
            const faculty = document.getElementById('facultySelect').value;
            const programSelect = document.getElementById('programSelect');
            const yearSelect = document.getElementById('yearSelect');
            
            // Reset program/year
            programSelect.innerHTML = '<option value="">Select a program...</option>';
            yearSelect.innerHTML = '<option value="">Select a year...</option>';
            programSelect.disabled = true;
            yearSelect.disabled = true;
            
            if (!faculty || !programPresets[faculty]) {
                return;
            }
            
            // Populate programs
            const programs = Object.keys(programPresets[faculty]);
            programs.forEach(p => {
                const opt = new Option(p, p);
                programSelect.appendChild(opt);
            });
            programSelect.disabled = programs.length === 0;
        }

        function handleProgramChange() {
            const faculty = document.getElementById('facultySelect').value;
            const program = document.getElementById('programSelect').value;
            const yearSelect = document.getElementById('yearSelect');
            
            // Reset years
            yearSelect.innerHTML = '<option value="">Select a year...</option>'; 
            yearSelect.disabled = true;
            
            if (!faculty || !program || !programPresets[faculty] || !programPresets[faculty][program]) {
                return;
            }
            
            // Populate years
            const years = Object.keys(programPresets[faculty][program]);
            years.forEach(y => {
                const opt = new Option(y, y);
                yearSelect.appendChild(opt);
            });
            yearSelect.disabled = years.length === 0;
        }

        function handleYearChange() {
            const faculty = document.getElementById('facultySelect').value;
            const program = document.getElementById('programSelect').value;
            const year = document.getElementById('yearSelect').value;
            
            if (!faculty || !program || !year) return;
            
            const courses = programPresets?.[faculty]?.[program]?.[year] || [];
            
            // Update selected courses and render bubbles
            selectedCourses.clear();
            courses.forEach(course => selectedCourses.add(course));
            renderSelectedCourseBubbles();
            

            
            // Update the timetable
            filterAndRenderTimetable();
        }
        
        // Course search and selection functions
        function handleCourseSearch(event) {
            const searchTerm = event.target.value.trim();
            
            if (searchTerm.length === 0) {
                hideCourseSuggestions();
                return;
            }
            
            // Search through available courses
            const suggestions = searchCourses(searchTerm);
            showCourseSuggestions(suggestions);
        }
        
        function searchCourses(searchTerm) {
            if (!allCourses || allCourses.length === 0) return [];
            
            const term = searchTerm.toLowerCase();
            const results = [];
            
            // Search by course code
            allCourses.forEach(course => {
                if (course.toLowerCase().includes(term)) {
                    results.push({
                        code: course,
                        title: getCourseTitle(course),
                        type: 'course'
                    });
                }
            });
            
            // Search by CRN if it's a 5-digit number
            if (/^\d{5}$/.test(searchTerm)) {
                courseData.forEach(entry => {
                    if (entry.crn === searchTerm) {
                        results.push({
                            code: entry.course,
                            title: getCourseTitle(entry.course),
                            type: 'crn',
                            crn: searchTerm
                        });
                    }

                });
            }
            
            // Limit results to 20
            return results.slice(0, 20);
        }
        
        function getCourseTitle(courseCode) {
            // Find a course entry with a title
            const entry = courseData.find(e => e.course === courseCode && e.sectionTitle);
            return entry ? entry.sectionTitle : '';
        }
        
        function showCourseSuggestions(suggestions = null) {
            const suggestionsDiv = document.getElementById('courseSuggestions');
            if (!suggestionsDiv) return;
            
            if (suggestions === null) {
                // Show all courses when focusing on empty input
                suggestions = allCourses.slice(0, 20).map(course => ({
                    code: course,
                    title: getCourseTitle(course),
                    type: 'course'
                }));
            }
            
            let html = `
                <div class="course-suggestions-header">
                    <span class="course-suggestions-title">Course Suggestions</span>
                    <button class="course-suggestions-close" onclick="hideCourseSuggestions()" title="Close">×</button>
                </div>
            `;
            
            if (suggestions.length === 0) {
                html += '<div class="course-suggestion-item">No courses found</div>';
            } else {
                suggestions.forEach(item => {
                    const titleText = item.title ? ` (${item.title})` : '';
                    html += `
                        <div class="course-suggestion-item" data-course="${item.code}" data-type="${item.type}">
                            <span class="course-suggestion-code">${item.code}</span>
                            <span class="course-suggestion-title">${titleText}</span>
                        </div>
                    `;
                });
            }
            
            suggestionsDiv.innerHTML = html;
            suggestionsDiv.classList.add('show');
            
            // Add click handlers to suggestions
            suggestionsDiv.querySelectorAll('.course-suggestion-item').forEach(item => {
                item.addEventListener('click', () => selectCourse(item.dataset.course));
            });
        }
        
        function hideCourseSuggestions() {
            // Delay hiding to allow clicks on suggestions
            setTimeout(() => {
                const suggestionsDiv = document.getElementById('courseSuggestions');
                if (suggestionsDiv) {
                    suggestionsDiv.classList.remove('show');
                }
            }, 200);
        }
        
        function selectCourse(courseCode) {
            if (!courseCode) return;
            
            selectedCourses.add(courseCode);
            renderSelectedCourseBubbles();
            
            // Clear the search input
            document.getElementById('courseFilter').value = '';
            hideCourseSuggestions();
            

            
            // Update the timetable
            filterAndRenderTimetable();
        }
        
        function removeCourse(courseCode) {
            // Find the bubble element and add removal animation
            const bubble = document.querySelector(`[data-course="${courseCode}"]`);
            if (bubble) {
                bubble.classList.add('removing');
                setTimeout(() => {
                    selectedCourses.delete(courseCode);
                    renderSelectedCourseBubbles();
                    

                    
                    // Update the timetable
                    filterAndRenderTimetable();
                }, 300); // Wait for animation to complete
            } else {
                // Fallback if bubble not found
                selectedCourses.delete(courseCode);
                renderSelectedCourseBubbles();
                

                
                filterAndRenderTimetable();
            }
        }
        
        function renderSelectedCourseBubbles() {
            const container = document.getElementById('selectedCourses');
            const noCoursesMessage = document.getElementById('noCoursesMessage');
            if (!container) return;
            
            if (selectedCourses.size === 0) {
                container.innerHTML = '';
                if (noCoursesMessage) {
                    noCoursesMessage.style.display = 'block';
                }
                return;
            }
            
            if (noCoursesMessage) {
                noCoursesMessage.style.display = 'none';
            }
            
            let html = '';
            selectedCourses.forEach(course => {
                html += `
                    <div class="course-bubble" data-course="${course}">
                        <span>${course}</span>
                        <button class="remove-btn" onclick="removeCourse('${course}')" title="Remove ${course}">×</button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function handleCourseSearchKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const searchTerm = event.target.value.trim();
                
                if (searchTerm) {
                    // Try to find an exact course match
                    const exactMatch = allCourses.find(course => 
                        course.toLowerCase() === searchTerm.toLowerCase()
                    );
                    
                    if (exactMatch) {
                        selectCourse(exactMatch);
                    } else {
                        // If no exact match, try to add as a custom course code
                        const upperCourse = searchTerm.toUpperCase();
                        if (/^[A-Z]+\d+[A-Z]*$/.test(upperCourse)) {
                            selectCourse(upperCourse);
                        } else {
                            // Show error or add anyway
                            selectCourse(upperCourse);
                        }
                    }
                }
            }
        }

        function handlePriorityToggle() {
            const dropdown = document.getElementById('priorityMenu');
            const toggle = document.getElementById('priorityToggle');
            
            dropdown.classList.toggle('show');
            toggle.classList.toggle('active');
        }

        function clearAllPriority() {
            // Uncheck all priority checkboxes
            document.querySelectorAll('.priority-course-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        function initializeAdvancedSettings() {
            // Populate day-specific time dropdowns
            const dayNames = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
            dayNames.forEach(day => {
                const startSelect = document.getElementById(day + 'Start');
                const endSelect = document.getElementById(day + 'End');
                
                // Populate with time options (15-minute intervals)
                for (let hour = 8; hour <= 20; hour++) {
                    ['00', '15', '30', '45'].forEach(minute => {
                        if (hour === 20 && minute === '45') return; // Skip 8:45 PM
                        const timeValue = `${hour.toString().padStart(2, '0')}:${minute}`;
                        const timeDisplay = formatDisplayTime(timeValue);
                        
                        const startOption = new Option(timeDisplay, timeValue, false, timeValue === '08:00');
                        const endOption = new Option(timeDisplay, timeValue, false, timeValue === '20:00');
                        
                        startSelect.appendChild(startOption);
                        endSelect.appendChild(endOption);
                    });
                }
            });
        }

        function handleAdvancedToggle() {
            const content = document.getElementById('advancedContent');
            const toggle = document.getElementById('advancedToggle');
            
            content.classList.toggle('show');
            toggle.classList.toggle('active');
            
            const arrow = toggle.querySelector('.dropdown-arrow');
            arrow.style.transform = content.classList.contains('show') ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        function handleDaySpecificToggle() {
            const isEnabled = document.getElementById('enableDaySpecific').checked;
            const dayTimeConfig = document.getElementById('dayTimeConfig');
            
            dayTimeConfig.style.display = isEnabled ? 'grid' : 'none';
        }

        function resetToDefaults() {
            // Reset conflict scores
            document.getElementById('scoreNonPriorityOther').value = '1';
            document.getElementById('scoreNonPriorityLecture').value = '5';
            document.getElementById('scorePriorityOther').value = '3';
            document.getElementById('scorePriorityLecture').value = '20';
            
            // Reset results settings
            const numRecs = document.getElementById('numRecommendations');
            if (numRecs) numRecs.value = '10';
            
            // Reset lunch settings
            document.getElementById('avoidLunch').checked = false;
            document.getElementById('lunchStartTime').value = '12:00';
            document.getElementById('lunchEndTime').value = '13:30';
            document.getElementById('lunchPenalty').value = '50';
            
            // Reset day-specific settings
            document.getElementById('enableDaySpecific').checked = false;
            handleDaySpecificToggle();
            const dayNames = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
            dayNames.forEach(day => {
                document.getElementById(day + 'Start').value = '08:00';
                document.getElementById(day + 'End').value = '20:00';
            });
            
            // Reset buffer settings
            document.getElementById('enableBuffer').checked = false;
            document.getElementById('bufferBeforeLecture').value = '0';
            document.getElementById('bufferAfterLecture').value = '0';
            document.getElementById('bufferBeforeOther').value = '0';
            document.getElementById('bufferAfterOther').value = '0';
            
            // Reset enrollment settings
            document.getElementById('enableEnrollmentWeighting').checked = false;
            document.getElementById('baseEnrollmentFirst').value = '200';
            document.getElementById('baseEnrollmentUpper').value = '100';
            document.getElementById('lectureEnrollmentMultiplier').value = '1.0';
            document.getElementById('tutorialEnrollmentFraction').value = '0.3';
            
            showStatus('Settings reset to defaults');
        }

        function initializeTooltipPositioning() {
        // Add event listeners to all info icons to adjust tooltip positioning
        document.querySelectorAll('.info-icon').forEach(icon => {
            icon.addEventListener('mouseenter', function() {
                const tooltip = this.querySelector('.info-tooltip');
                if (tooltip) {
                    // Remove any previous positioning classes
                    tooltip.classList.remove('adjust-position');
                    
                    // Small delay to allow tooltip to render
                    setTimeout(() => {
                        const iconRect = this.getBoundingClientRect();
                        const viewportHeight = window.innerHeight;
                        
                        // Check if tooltip would go off the top of the viewport
                        if (iconRect.top < 150) {
                            tooltip.classList.add('adjust-position');
                        }
                    }, 10);
                }
            });
        });
    }

        function getAdvancedSettings() {
            return {
                scores: {
                    nonPriorityOther: parseInt(document.getElementById('scoreNonPriorityOther').value) || 1,
                    nonPriorityLecture: parseInt(document.getElementById('scoreNonPriorityLecture').value) || 5,
                    priorityOther: parseInt(document.getElementById('scorePriorityOther').value) || 3,
                    priorityLecture: parseInt(document.getElementById('scorePriorityLecture').value) || 20
                },
                results: {
                    numRecommendations: Math.max(1, Math.min(50, parseInt(document.getElementById('numRecommendations').value) || 10))
                },
                lunch: {
                    avoid: document.getElementById('avoidLunch').checked,
                    startTime: document.getElementById('lunchStartTime').value,
                    endTime: document.getElementById('lunchEndTime').value,
                    penalty: parseInt(document.getElementById('lunchPenalty').value) || 50
                },
                daySpecific: {
                    enabled: document.getElementById('enableDaySpecific').checked,
                    times: {
                        monday: {
                            start: document.getElementById('mondayStart').value,
                            end: document.getElementById('mondayEnd').value
                        },
                        tuesday: {
                            start: document.getElementById('tuesdayStart').value,
                            end: document.getElementById('tuesdayEnd').value
                        },
                        wednesday: {
                            start: document.getElementById('wednesdayStart').value,
                            end: document.getElementById('wednesdayEnd').value
                        },
                        thursday: {
                            start: document.getElementById('thursdayStart').value,
                            end: document.getElementById('thursdayEnd').value
                        },
                        friday: {
                            start: document.getElementById('fridayStart').value,
                            end: document.getElementById('fridayEnd').value
                        }
                    }
                },
                buffer: {
                    enabled: document.getElementById('enableBuffer').checked,
                    beforeLecture: parseInt(document.getElementById('bufferBeforeLecture').value) || 15,
                    afterLecture: parseInt(document.getElementById('bufferAfterLecture').value) || 15,
                    beforeOther: parseInt(document.getElementById('bufferBeforeOther').value) || 10,
                    afterOther: parseInt(document.getElementById('bufferAfterOther').value) || 10
                },
                enrollment: {
                    enabled: document.getElementById('enableEnrollmentWeighting').checked,
                    baseFirst: parseInt(document.getElementById('baseEnrollmentFirst').value) || 200,
                    baseUpper: parseInt(document.getElementById('baseEnrollmentUpper').value) || 100,
                    lectureMultiplier: parseFloat(document.getElementById('lectureEnrollmentMultiplier').value) || 1.0,
                    tutorialFraction: parseFloat(document.getElementById('tutorialEnrollmentFraction').value) || 0.3
                }
            };
        }

        function isFirstYearCourse(course) {
            const match = course.match(/\d{4}/);
            if (!match) return false;
            const courseNumber = match[0];
            return courseNumber.startsWith('1') || courseNumber.startsWith('0');
        }

        function estimateEnrollment(entry, settings) {
            // This is now a fallback function when actual enrollment isn't available
            const baseEnrollment = isFirstYearCourse(entry.course) ? 
                settings.enrollment.baseFirst : settings.enrollment.baseUpper;
            
            if (entry.type === 'lecture') {
                return Math.round(baseEnrollment * settings.enrollment.lectureMultiplier);
            } else {
                return Math.round(baseEnrollment * settings.enrollment.tutorialFraction);
            }
        }

        function getActualEnrollment(entry) {
            // Find matching course data with actual enrollment
            const matchingEntries = courseData.filter(courseEntry => 
                courseEntry.course === entry.course && 
                courseEntry.type === entry.type &&
                courseEntry.day === entry.day &&
                courseEntry.startTime === entry.startTime
            );
            
            if (matchingEntries.length > 0) {
                // Use the 'Act' (actual enrollment) from the first matching entry
                return matchingEntries[0].actualEnrollment || 0;
            }
            
            // Fallback to estimation if no actual data found
            return estimateEnrollment(entry, getAdvancedSettings());
        }

        function isInLunchPeriod(timeSlot, settings) {
            if (!settings.lunch.avoid) return false;
            
            const lunchStart = timeSlots.indexOf(settings.lunch.startTime);
            const lunchEnd = timeSlots.indexOf(settings.lunch.endTime);
            const currentSlot = timeSlots.indexOf(timeSlot);
            
            return currentSlot >= lunchStart && currentSlot < lunchEnd;
        }

        function hasBufferConflict(day, timeSlot, settings, currentData) {
            // This function is no longer used - buffer logic is now integrated into main conflict detection
            return { hasConflict: false, details: [] };
        }

        function populatePriorityCourses() {
            const priorityList = document.getElementById('priorityCoursesList');
            if (!priorityList) return;
            
            // Get currently filtered courses
            let filteredCourses = [];

            if (selectedCourses.size > 0) {
                filteredCourses = Array.from(selectedCourses);
            } else {
                filteredCourses = allCourses;
            }

            // Get unique courses with their titles
            const courseMap = new Map();
            courseData.forEach(entry => {
                if (filteredCourses.length === 0 || filteredCourses === allCourses || 
                    filteredCourses.some(filterCourse => {
                        return entry.course === filterCourse || 
                               entry.course.startsWith(filterCourse) || 
                               entry.course.includes(filterCourse);
                    })) {
                    // If we don't have a title for this course yet, or if this entry has a better title
                    if (!courseMap.has(entry.course) || 
                        (entry.sectionTitle && entry.sectionTitle.length > (courseMap.get(entry.course).title || '').length)) {
                        courseMap.set(entry.course, {
                            title: entry.sectionTitle || '',
                            course: entry.course
                        });
                    }
                }
            });

            const actualFilteredCourses = Array.from(courseMap.values()).sort((a, b) => a.course.localeCompare(b.course));

            priorityList.innerHTML = '';
            
            if (actualFilteredCourses.length === 0) {
                priorityList.innerHTML = '<div style="padding: 15px; color: #6c757d; text-align: center;">No courses available</div>';
                return;
            }

            actualFilteredCourses.forEach(courseInfo => {
                const itemDiv = document.createElement('label');
                itemDiv.className = 'priority-course-item';
                
                // Display course number with title in brackets if available
                const displayText = courseInfo.title ? 
                    `${courseInfo.course} (${courseInfo.title})` : 
                    courseInfo.course;
                
                itemDiv.innerHTML = `
                    <input type="checkbox" class="priority-course-checkbox" data-course="${courseInfo.course}">
                    <span class="checkmark"></span>
                    <span>${displayText}</span>
                `;
                priorityList.appendChild(itemDiv);
            });
        }

        function getPriorityCourses() {
            return Array.from(document.querySelectorAll('.priority-course-checkbox:checked'))
                .map(checkbox => checkbox.dataset.course);
        }

        // Replace your existing calculateConflictScore function with this fixed version
        function calculateConflictScore(day, timeSlot) {
            const settings = getAdvancedSettings();
            const currentData = courseData.filter(entry => {
                // Filter to currently displayed courses
                let filteredCourses = [];

                if (selectedCourses.size > 0) {
                    filteredCourses = Array.from(selectedCourses);
                } else {
                    filteredCourses = allCourses;
                }

                const matches = filteredCourses.length === 0 || filteredCourses === allCourses || 
                    filteredCourses.some(filterCourse => {
                        return entry.course === filterCourse || 
                            entry.course.startsWith(filterCourse) || 
                            entry.course.includes(filterCourse);
                    });

                return matches && entry.day === day;
            });

            const priorityCourses = getPriorityCourses();
            let score = 0;

            // Check for lunch period penalty
            if (isInLunchPeriod(timeSlot, settings)) {
                score += settings.lunch.penalty;
            }

            // Group courses by course+type to avoid counting multiple sections
            const courseConflicts = new Map();
            const currentSlotIndex = timeSlots.indexOf(timeSlot);

            currentData.forEach(entry => {
                const entryStartSlot = findTimeSlot(entry.startTime);
                const entryEndSlot = entryStartSlot + Math.ceil(entry.duration / 30) - 1;
                
                // Calculate buffer zones if enabled
                let bufferedStartSlot = entryStartSlot;
                let bufferedEndSlot = entryEndSlot;
                
                if (settings.buffer.enabled) {
                    const bufferBefore = entry.type === 'lecture' ? 
                        Math.ceil(settings.buffer.beforeLecture / 30) : 
                        Math.ceil(settings.buffer.beforeOther / 30);
                        
                    const bufferAfter = entry.type === 'lecture' ? 
                        Math.ceil(settings.buffer.afterLecture / 30) : 
                        Math.ceil(settings.buffer.afterOther / 30);
                        
                    bufferedStartSlot = Math.max(0, entryStartSlot - bufferBefore);
                    bufferedEndSlot = Math.min(timeSlots.length - 1, entryEndSlot + bufferAfter);
                }

                // Check if current slot overlaps with buffered time range
                if (currentSlotIndex >= bufferedStartSlot && currentSlotIndex <= bufferedEndSlot) {
                    // Group by course+type to count each course only once
                    const courseTypeKey = `${entry.course}-${entry.type}`;
                    
                    if (!courseConflicts.has(courseTypeKey)) {
                        courseConflicts.set(courseTypeKey, {
                            course: entry.course,
                            type: entry.type,
                            entries: [entry]
                        });
                    } else {
                        // Add to existing group but don't create duplicate
                        courseConflicts.get(courseTypeKey).entries.push(entry);
                    }
                }
            });

            // Calculate score for each unique course+type combination
            courseConflicts.forEach(conflictGroup => {
                const isPriority = priorityCourses.includes(conflictGroup.course);
                const isLecture = conflictGroup.type === 'lecture';

                let baseScore;
                if (isPriority) {
                    baseScore = isLecture ? settings.scores.priorityLecture : settings.scores.priorityOther;
                } else {
                    baseScore = isLecture ? settings.scores.nonPriorityLecture : settings.scores.nonPriorityOther;
                }

                // Apply enrollment weighting if enabled
                if (settings.enrollment.enabled) {
                    // For multiple sections, sum enrollments
                    let totalEnrollment = 0;
                    conflictGroup.entries.forEach(entry => {
                        const enrollment = getActualEnrollment(entry);
                        totalEnrollment += enrollment;
                    });
                    
                    if (totalEnrollment > 0) {
                        const enrollmentMultiplier = totalEnrollment / 50;
                        baseScore = Math.round(baseScore * enrollmentMultiplier);
                    }
                }

                score += baseScore;
            });

            return score;
        }

        // Fixed version - counts each conflicting course only once per workshop
        function calculateWorkshopConflictScore(day, startTime, duration) {
            const settings = getAdvancedSettings();
            const slotsNeeded = Math.ceil(duration / 30);
            const startIndex = timeSlots.indexOf(startTime);
            
            // Get currently filtered data
            let filteredCourses = [];

            if (selectedCourses.size > 0) {
                filteredCourses = Array.from(selectedCourses);
            } else {
                filteredCourses = allCourses;
            }

            const currentData = courseData.filter(entry => {
                const matches = filteredCourses.length === 0 || filteredCourses === allCourses || 
                    filteredCourses.some(filterCourse => {
                        return entry.course === filterCourse || 
                            entry.course.startsWith(filterCourse) || 
                            entry.course.includes(filterCourse);
                    });
                return matches && entry.day === day;
            });

            const priorityCourses = getPriorityCourses();
            let score = 0;

            // Check for lunch period penalty (count once if any workshop slot overlaps)
            let lunchPenaltyAdded = false;
            for (let i = 0; i < slotsNeeded; i++) {
                const slotIndex = startIndex + i;
                if (slotIndex < timeSlots.length) {
                    const timeSlot = timeSlots[slotIndex];
                    if (isInLunchPeriod(timeSlot, settings) && !lunchPenaltyAdded) {
                        score += settings.lunch.penalty;
                        lunchPenaltyAdded = true;
                        break;
                    }
                }
            }

            // Track individual sections that have already been counted to avoid double-counting 
            // the same section multiple times across different workshop time slots
            const processedSections = new Set();
            
            currentData.forEach(entry => {
                const entryStartSlot = findTimeSlot(entry.startTime);
                const entryEndSlot = entryStartSlot + Math.ceil(entry.duration / 30) - 1;
                
                // Calculate buffer zones if enabled
                let bufferedStartSlot = entryStartSlot;
                let bufferedEndSlot = entryEndSlot;
                
                if (settings.buffer.enabled) {
                    const bufferBefore = entry.type === 'lecture' ? 
                        Math.ceil(settings.buffer.beforeLecture / 30) : 
                        Math.ceil(settings.buffer.beforeOther / 30);
                        
                    const bufferAfter = entry.type === 'lecture' ? 
                        Math.ceil(settings.buffer.afterLecture / 30) : 
                        Math.ceil(settings.buffer.afterOther / 30);
                        
                    bufferedStartSlot = Math.max(0, entryStartSlot - bufferBefore);
                    bufferedEndSlot = Math.min(timeSlots.length - 1, entryEndSlot + bufferAfter);
                }

                // Check if workshop time range overlaps with buffered course time range
                const workshopStartSlot = startIndex;
                const workshopEndSlot = startIndex + slotsNeeded - 1;
                
                const hasOverlap = workshopStartSlot <= bufferedEndSlot && workshopEndSlot >= bufferedStartSlot;
                
                if (hasOverlap) {
                    // Create unique identifier for this specific section (includes all identifying info)
                    const sectionKey = `${entry.course}-${entry.type}-${entry.startTime}-${entry.day}-${entry.instructor}-${entry.location}`;
                    
                    if (!processedSections.has(sectionKey)) {
                        processedSections.add(sectionKey);
                        
                        const isPriority = priorityCourses.includes(entry.course);
                        const isLecture = entry.type === 'lecture';

                        let baseScore;
                        if (isPriority) {
                            baseScore = isLecture ? settings.scores.priorityLecture : settings.scores.priorityOther;
                        } else {
                            baseScore = isLecture ? settings.scores.nonPriorityLecture : settings.scores.nonPriorityOther;
                        }

                        // Apply enrollment weighting if enabled
                        if (settings.enrollment.enabled) {
                            const enrollment = getActualEnrollment(entry);
                            if (enrollment > 0) {
                                const enrollmentMultiplier = enrollment / 50;
                                baseScore = Math.round(baseScore * enrollmentMultiplier);
                            }
                        }

                        score += baseScore;
                    }
                }
            });

            return score;
        }

        // Updated findOptimalWorkshopTimes function
        function findOptimalWorkshopTimes() {
            const duration = parseInt(document.getElementById('workshopDuration').value) || 60;
            const settings = getAdvancedSettings();
            
            const opportunities = [];
            const slotsNeeded = Math.ceil(duration / 30);

            days.forEach(day => {
                let earliestTime, latestTime;
                
                if (settings.daySpecific.enabled) {
                    const dayKey = day.toLowerCase();
                    earliestTime = settings.daySpecific.times[dayKey].start;
                    latestTime = settings.daySpecific.times[dayKey].end;
                } else {
                    earliestTime = document.getElementById('earliestTime').value;
                    latestTime = document.getElementById('latestTime').value;
                }
                
                const earliestIndex = timeSlots.indexOf(earliestTime);
                const latestIndex = timeSlots.indexOf(latestTime);
                
                if (earliestIndex === -1 || latestIndex === -1 || earliestIndex >= latestIndex) {
                    return;
                }

                for (let startIndex = earliestIndex; startIndex <= latestIndex - slotsNeeded; startIndex++) {
                    const startTime = timeSlots[startIndex];
                    const endTime = addMinutes(startTime, duration);
                    
                    // Use the new single-calculation method
                    const totalScore = calculateWorkshopConflictScore(day, startTime, duration);
                    
                    opportunities.push({
                        day,
                        startTime,
                        endTime,
                        totalScore,
                        details: [] // You can populate this if needed for debugging
                    });
                }
            });

            // Sort by score (lower is better)
            opportunities.sort((a, b) => a.totalScore - b.totalScore);
            // Save full ranked list for CSV download
            lastRankedOpportunities = opportunities.slice();
            const numToShow = getAdvancedSettings().results.numRecommendations;
            displayWorkshopResults(opportunities.slice(0, numToShow), duration);

            // Auto-collapse Advanced Settings after search
            const advContent = document.getElementById('advancedContent');
            const advToggle = document.getElementById('advancedToggle');
            if (advContent && advToggle) {
                advContent.classList.remove('show');
                advToggle.classList.remove('active');
                const arrow = advToggle.querySelector('.dropdown-arrow');
                if (arrow) {
                    arrow.style.transform = 'rotate(0deg)';
                }
            }

            // Show CSV download button if we have results
            const dlBtn = document.getElementById('downloadCsvRecommendations');
            if (dlBtn) {
                dlBtn.style.display = opportunities.length > 0 ? 'inline-block' : 'none';
            }
        }

        function downloadRecommendationsCsv() {
            if (!Array.isArray(lastRankedOpportunities) || lastRankedOpportunities.length === 0) {
                alert('No recommendations to export yet. Please run a search first.');
                return;
            }

            // Map day names to abbreviations
            const dayAbbrev = { 'Monday': 'M', 'Tuesday': 'T', 'Wednesday': 'W', 'Thursday': 'R', 'Friday': 'F' };

            // Build CSV lines
            const lines = [];
            lines.push(['Day of week', 'Start Time', 'End Time', 'Score'].join(','));
            lastRankedOpportunities.forEach(opp => {
                const day = dayAbbrev[opp.day] || opp.day;
                const start = formatDisplayTime(opp.startTime);
                const end = formatDisplayTime(opp.endTime);
                const score = opp.totalScore;
                lines.push([day, start, end, score].join(','));
            });

            const csvContent = lines.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            const now = new Date();
            const pad = (n) => String(n).padStart(2, '0');
            const ts = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(now.getSeconds())}`;
            link.download = `recommended_times_${ts}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function isCRN(input) {
            return /^\d{5}$/.test(input.trim());
        }

        // Updated displayWorkshopResults function - replace the tooltip generation part
        function displayWorkshopResults(opportunities, duration) {
            const resultsDiv = document.getElementById('workshopResults');
            const contentDiv = document.getElementById('resultsContent');
            const explanationDiv = document.getElementById('scoringExplanation');

            if (opportunities.length === 0) {
                contentDiv.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 20px;">No suitable time slots found. Try adjusting your parameters.</div>';
                resultsDiv.style.display = 'block';
                explanationDiv.style.display = 'block';
                return;
            }

            let html = '';
            opportunities.forEach((opp, index) => {
                const ranking = index + 1;
                const startTimeFormatted = formatDisplayTime(opp.startTime);
                const endTimeFormatted = formatDisplayTime(opp.endTime);
                
                // Get conflict details using the new function
                const conflictDetails = getWorkshopConflictDetailsForDisplay(opp.day, opp.startTime, duration);

                // Build tooltip content
                let tooltipContent = '<div class="workshop-tooltip">';

                if (conflictDetails.conflicts.length === 0 && !conflictDetails.lunchConflict) {
                    tooltipContent += '<div class="no-conflicts">No conflicts detected!</div>';
                } else {
                    tooltipContent += '<strong>Score Breakdown (Total: ' + conflictDetails.totalScore + '):</strong>';
                    tooltipContent += '<div class="conflict-list">';
                    
                    // Add lunch penalty if applicable
                    if (conflictDetails.lunchConflict) {
                        tooltipContent += '<div class="conflict-item">';
                        tooltipContent += '<span class="conflict-course">Lunch Period: +' + conflictDetails.settings.lunch.penalty + '</span>';
                        tooltipContent += '</div>';
                    }
                    
                    // Add course conflicts
                    conflictDetails.conflicts.forEach(conflict => {
                        tooltipContent += '<div class="conflict-item">';
                        const enrollmentText = conflictDetails.settings.enrollment.enabled && conflict.enrollment > 0 
                            ? ` (${conflict.enrollment} students)` : '';
                        tooltipContent += '<span class="conflict-course" style="font-size: 11px; max-width: 300px; word-wrap: break-word;">' + 
                            conflict.course + ' ' + conflict.type + ': +' + conflict.finalScore + enrollmentText + '</span>';
                        tooltipContent += '</div>';
                    });
                    
                    tooltipContent += '</div>';
                }

                tooltipContent += '</div>';
                
                html += `
                    <div class="result-item">
                        ${tooltipContent}
                        <div class="result-header">
                            #${ranking} - ${opp.day}, ${startTimeFormatted} - ${endTimeFormatted}
                            <span class="conflict-score">Score: ${opp.totalScore}</span>
                        </div>
                        <div class="result-details">
                            Duration: ${duration} minutes | Conflict Level: ${opp.totalScore === 0 ? 'None' : opp.totalScore < 5 ? 'Low' : opp.totalScore < 15 ? 'Medium' : 'High'}
                        </div>
                    </div>
                `;
            });

            contentDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
            explanationDiv.style.display = 'block';
        }

        // Replace the conflict details generation in displayWorkshopResults
        function getWorkshopConflictDetailsForDisplay(day, startTime, duration) {
            const settings = getAdvancedSettings();
            const slotsNeeded = Math.ceil(duration / 30);
            const startIndex = timeSlots.indexOf(startTime);
            
            // Get currently filtered data
            let filteredCourses = [];

            if (selectedCourses.size > 0) {
                filteredCourses = Array.from(selectedCourses);
            } else {
                filteredCourses = allCourses;
            }

            const currentData = courseData.filter(entry => {
                const matches = filteredCourses.length === 0 || filteredCourses === allCourses || 
                    filteredCourses.some(filterCourse => {
                        return entry.course === filterCourse || 
                            entry.course.startsWith(filterCourse) || 
                            entry.course.includes(filterCourse);
                    });
                return matches && entry.day === day;
            });

            const priorityCourses = getPriorityCourses();
            let totalScore = 0;
            const conflicts = [];
            let lunchConflict = false;
            
            // Check for lunch period penalty (once for entire workshop)
            let hasLunchOverlap = false;
            for (let i = 0; i < slotsNeeded && !hasLunchOverlap; i++) {
                const slotIndex = startIndex + i;
                if (slotIndex < timeSlots.length) {
                    const timeSlot = timeSlots[slotIndex];
                    if (isInLunchPeriod(timeSlot, settings)) {
                        hasLunchOverlap = true;
                        lunchConflict = true;
                        totalScore += settings.lunch.penalty;
                    }
                }
            }
            
            // Track individual sections that have already been counted
            const processedSections = new Set();
            
            currentData.forEach(entry => {
                const entryStartSlot = findTimeSlot(entry.startTime);
                const entryEndSlot = entryStartSlot + Math.ceil(entry.duration / 30) - 1;
                
                // Calculate buffer zones if enabled
                let bufferedStartSlot = entryStartSlot;
                let bufferedEndSlot = entryEndSlot;
                
                if (settings.buffer.enabled) {
                    const bufferBefore = entry.type === 'lecture' ? 
                        Math.ceil(settings.buffer.beforeLecture / 30) : 
                        Math.ceil(settings.buffer.beforeOther / 30);
                        
                    const bufferAfter = entry.type === 'lecture' ? 
                        Math.ceil(settings.buffer.afterLecture / 30) : 
                        Math.ceil(settings.buffer.afterOther / 30);
                        
                    bufferedStartSlot = Math.max(0, entryStartSlot - bufferBefore);
                    bufferedEndSlot = Math.min(timeSlots.length - 1, entryEndSlot + bufferAfter);
                }

                // Check if workshop time range overlaps with buffered course time range
                const workshopStartSlot = startIndex;
                const workshopEndSlot = startIndex + slotsNeeded - 1;
                
                const hasOverlap = workshopStartSlot <= bufferedEndSlot && workshopEndSlot >= bufferedStartSlot;
                
                if (hasOverlap) {
                    // Create unique identifier for this specific section
                    const sectionKey = `${entry.course}-${entry.type}-${entry.startTime}-${entry.day}-${entry.instructor}-${entry.location}`;
                    
                    if (!processedSections.has(sectionKey)) {
                        processedSections.add(sectionKey);
                        
                        const isPriority = priorityCourses.includes(entry.course);
                        const isLecture = entry.type === 'lecture';

                        let baseScore;
                        if (isPriority) {
                            baseScore = isLecture ? settings.scores.priorityLecture : settings.scores.priorityOther;
                        } else {
                            baseScore = isLecture ? settings.scores.nonPriorityLecture : settings.scores.nonPriorityOther;
                        }

                        let finalScore = baseScore;
                        let enrollment = 0;
                        
                        // Apply enrollment weighting if enabled
                        if (settings.enrollment.enabled) {
                            enrollment = getActualEnrollment(entry);
                            if (enrollment > 0) {
                                const enrollmentMultiplier = enrollment / 50;
                                finalScore = Math.round(baseScore * enrollmentMultiplier);
                            }
                        }

                        totalScore += finalScore;
                        
                        // Add to conflicts list for display
                        const isInBuffer = (workshopStartSlot >= bufferedStartSlot && workshopStartSlot <= bufferedEndSlot) && 
                                        !(workshopStartSlot >= entryStartSlot && workshopStartSlot <= entryEndSlot);
                        
                        conflicts.push({
                            course: entry.course,
                            type: entry.type,
                            startTime: entry.startTime,
                            endTime: entry.endTime,
                            isPriority,
                            baseScore,
                            finalScore,
                            enrollment,
                            instructor: entry.instructor || 'Unknown',
                            isInBuffer,
                            bufferBefore: settings.buffer.enabled ? (entry.type === 'lecture' ? settings.buffer.beforeLecture : settings.buffer.beforeOther) : 0,
                            bufferAfter: settings.buffer.enabled ? (entry.type === 'lecture' ? settings.buffer.afterLecture : settings.buffer.afterOther) : 0
                        });
                    }
                }
            });
            
            return {
                conflicts,
                lunchConflict,
                totalScore,
                settings
            };
        }

        function getWorkshopConflictDetails(day, startTime, duration) {
            const settings = getAdvancedSettings();
            const slotsNeeded = Math.ceil(duration / 30);
            const startIndex = timeSlots.indexOf(startTime);
            
            const conflicts = [];
            let lunchConflict = false;
            
            // Get currently filtered data
            let filteredCourses = [];

            if (selectedCourses.size > 0) {
                filteredCourses = Array.from(selectedCourses);
            } else {
                filteredCourses = allCourses;
            }

            const currentData = courseData.filter(entry => {
                const matches = filteredCourses.length === 0 || filteredCourses === allCourses || 
                    filteredCourses.some(filterCourse => {
                        return entry.course === filterCourse || 
                            entry.course.startsWith(filterCourse) || 
                            entry.course.includes(filterCourse);
                    });
                return matches && entry.day === day;
            });

            const priorityCourses = getPriorityCourses();
            
            // Check each slot in the workshop duration
            for (let i = 0; i < slotsNeeded; i++) {
                const slotIndex = startIndex + i;
                if (slotIndex >= timeSlots.length) continue;
                
                const timeSlot = timeSlots[slotIndex];
                
                // Check for lunch conflict
                if (isInLunchPeriod(timeSlot, settings)) {
                    lunchConflict = true;
                }
                
                // Check for course conflicts (including buffer zones)
                currentData.forEach(entry => {
                    const entryStartSlot = findTimeSlot(entry.startTime);
                    const entryEndSlot = entryStartSlot + Math.ceil(entry.duration / 30) - 1;
                    
                    // Calculate buffer zones if enabled
                    let bufferedStartSlot = entryStartSlot;
                    let bufferedEndSlot = entryEndSlot;
                    let isInBuffer = false;
                    
                    if (settings.buffer.enabled) {
                        const bufferBefore = entry.type === 'lecture' ? 
                            Math.ceil(settings.buffer.beforeLecture / 30) : 
                            Math.ceil(settings.buffer.beforeOther / 30);
                            
                        const bufferAfter = entry.type === 'lecture' ? 
                            Math.ceil(settings.buffer.afterLecture / 30) : 
                            Math.ceil(settings.buffer.afterOther / 30);
                            
                        bufferedStartSlot = Math.max(0, entryStartSlot - bufferBefore);
                        bufferedEndSlot = Math.min(timeSlots.length - 1, entryEndSlot + bufferAfter);
                        
                        // Check if we're only in the buffer zone (not the actual class)
                        isInBuffer = (slotIndex >= bufferedStartSlot && slotIndex <= bufferedEndSlot) && 
                                    !(slotIndex >= entryStartSlot && slotIndex <= entryEndSlot);
                    }
                    
                    if (slotIndex >= bufferedStartSlot && slotIndex <= bufferedEndSlot) {
                        const isPriority = priorityCourses.includes(entry.course);
                        const isLecture = entry.type === 'lecture';
                        
                        let baseScore;
                        if (isPriority) {
                            baseScore = isLecture ? settings.scores.priorityLecture : settings.scores.priorityOther;
                        } else {
                            baseScore = isLecture ? settings.scores.nonPriorityLecture : settings.scores.nonPriorityOther;
                        }
                        
                        let finalScore = baseScore;
                        let enrollment = 0;
                        
                        // Apply enrollment weighting if enabled
                        if (settings.enrollment.enabled) {
                            enrollment = getActualEnrollment(entry);
                            if (enrollment > 0) {
                                const enrollmentMultiplier = enrollment / 50;
                                finalScore = Math.round(baseScore * enrollmentMultiplier);
                            }
                        }
                        
                        // Check if this conflict is already recorded
                        const existingConflict = conflicts.find(c => 
                            c.course === entry.course && 
                            c.type === entry.type &&
                            c.startTime === entry.startTime
                        );
                        
                        if (!existingConflict) {
                            conflicts.push({
                                course: entry.course,
                                type: entry.type,
                                startTime: entry.startTime,
                                endTime: entry.endTime,
                                isPriority,
                                baseScore,
                                finalScore,
                                enrollment,
                                instructor: entry.instructor || 'Unknown',
                                isInBuffer,
                                bufferBefore: settings.buffer.enabled ? (entry.type === 'lecture' ? settings.buffer.beforeLecture : settings.buffer.beforeOther) : 0,
                                bufferAfter: settings.buffer.enabled ? (entry.type === 'lecture' ? settings.buffer.afterLecture : settings.buffer.afterOther) : 0
                            });
                        }
                    }
                });
            }
            
            return {
                conflicts,
                lunchConflict,
                settings
            };
        }

        function debugCalculateConflictScore(day, timeSlot) {
            console.log(`\n=== DEBUG CONFLICT SCORE for ${day} at ${timeSlot} ===`);
            
            const settings = getAdvancedSettings();
            console.log('Settings:', settings);
            
            const currentData = courseData.filter(entry => {
                // Filter to currently displayed courses
                let filteredCourses = [];

                if (selectedCourses.size > 0) {
                    filteredCourses = Array.from(selectedCourses);
                } else {
                    filteredCourses = allCourses;
                }

                const matches = filteredCourses.length === 0 || filteredCourses === allCourses || 
                    filteredCourses.some(filterCourse => {
                        return entry.course === filterCourse || 
                            entry.course.startsWith(filterCourse) || 
                            entry.course.includes(filterCourse);
                    });

                return matches && entry.day === day;
            });

            console.log(`Found ${currentData.length} courses on ${day}:`, currentData.map(e => `${e.course} ${e.type}`));

            const priorityCourses = getPriorityCourses();
            console.log('Priority courses:', priorityCourses);
            
            let score = 0;
            let scoreBreakdown = [];

            // Check for lunch period penalty
            if (isInLunchPeriod(timeSlot, settings)) {
                const lunchScore = settings.lunch.penalty;
                score += lunchScore;
                scoreBreakdown.push(`Lunch Period: +${lunchScore}`);
                console.log(`Lunch period penalty: +${lunchScore}`);
            }

            currentData.forEach(entry => {
                console.log(`\nProcessing ${entry.course} ${entry.type}:`);
                
                const entryStartSlot = findTimeSlot(entry.startTime);
                const entryEndSlot = entryStartSlot + Math.ceil(entry.duration / 30) - 1;
                const currentSlotIndex = timeSlots.indexOf(timeSlot);
                
                console.log(`  Entry spans slots ${entryStartSlot}-${entryEndSlot} (${timeSlots[entryStartSlot]}-${timeSlots[entryEndSlot]})`);
                console.log(`  Current slot index: ${currentSlotIndex} (${timeSlot})`);
                
                // Calculate buffer zones if enabled
                let bufferedStartSlot = entryStartSlot;
                let bufferedEndSlot = entryEndSlot;
                let bufferInfo = '';
                
                if (settings.buffer.enabled) {
                    const bufferBefore = entry.type === 'lecture' ? 
                        Math.ceil(settings.buffer.beforeLecture / 30) : 
                        Math.ceil(settings.buffer.beforeOther / 30);
                        
                    const bufferAfter = entry.type === 'lecture' ? 
                        Math.ceil(settings.buffer.afterLecture / 30) : 
                        Math.ceil(settings.buffer.afterOther / 30);
                        
                    bufferedStartSlot = Math.max(0, entryStartSlot - bufferBefore);
                    bufferedEndSlot = Math.min(timeSlots.length - 1, entryEndSlot + bufferAfter);
                    
                    console.log(`  Buffer: ${bufferBefore} slots before, ${bufferAfter} slots after`);
                    console.log(`  Buffered span: slots ${bufferedStartSlot}-${bufferedEndSlot}`);
                    
                    const isInActualClass = currentSlotIndex >= entryStartSlot && currentSlotIndex <= entryEndSlot;
                    const isInBufferZone = (currentSlotIndex >= bufferedStartSlot && currentSlotIndex <= bufferedEndSlot) && !isInActualClass;
                    
                    if (isInBufferZone) {
                        bufferInfo = ' (in buffer zone)';
                        console.log(`  Current slot is in buffer zone`);
                    } else if (isInActualClass) {
                        console.log(`  Current slot is in actual class`);
                    }
                }

                // Check if workshop slot overlaps with buffered time range
                if (currentSlotIndex >= bufferedStartSlot && currentSlotIndex <= bufferedEndSlot) {
                    console.log(`  CONFLICT DETECTED!`);
                    
                    const isPriority = priorityCourses.includes(entry.course);
                    const isLecture = entry.type === 'lecture';
                    
                    console.log(`  isPriority: ${isPriority}, isLecture: ${isLecture}`);

                    let baseScore;
                    if (isPriority) {
                        baseScore = isLecture ? settings.scores.priorityLecture : settings.scores.priorityOther;
                    } else {
                        baseScore = isLecture ? settings.scores.nonPriorityLecture : settings.scores.nonPriorityOther;
                    }
                    
                    console.log(`  Base score: ${baseScore}`);

                    let finalScore = baseScore;
                    
                    // Apply enrollment weighting if enabled
                    if (settings.enrollment.enabled) {
                        const enrollment = getActualEnrollment(entry);
                        console.log(`  Enrollment: ${enrollment}`);
                        
                        if (enrollment > 0) {
                            const enrollmentMultiplier = enrollment / 50;
                            finalScore = Math.round(baseScore * enrollmentMultiplier);
                            console.log(`  Enrollment multiplier: ${enrollmentMultiplier.toFixed(2)}, final score: ${finalScore}`);
                            scoreBreakdown.push(`${entry.course} ${entry.type}${bufferInfo}: +${baseScore} (base) × ${enrollmentMultiplier.toFixed(2)} (enrollment) = +${finalScore}`);
                        } else {
                            console.log(`  No enrollment data, using base score: ${finalScore}`);
                            scoreBreakdown.push(`${entry.course} ${entry.type}${bufferInfo}: +${finalScore}`);
                        }
                    } else {
                        console.log(`  Enrollment weighting disabled, using base score: ${finalScore}`);
                        scoreBreakdown.push(`${entry.course} ${entry.type}${bufferInfo}: +${finalScore}`);
                    }

                    score += finalScore;
                    console.log(`  Added ${finalScore} to score. Running total: ${score}`);
                } else {
                    console.log(`  No conflict - slot ${currentSlotIndex} not in range ${bufferedStartSlot}-${bufferedEndSlot}`);
                }
            });

            console.log(`\nFINAL DEBUG SCORE: ${score}`);
            console.log('Breakdown:', scoreBreakdown);
            console.log('=== END DEBUG ===\n');
            
            return { score, breakdown: scoreBreakdown };
        }

        function exportTimetablePDF() {
            console.log('🚀 Starting PDF export...');
            
            const exportBtn = document.getElementById('exportPdf');
            
            // Check if html2pdf library is loaded
            if (typeof html2pdf === 'undefined') {
                console.error('❌ html2pdf library not loaded');
                alert('PDF library not loaded. Please refresh the page and try again.');
                return;
            }
            console.log('✅ html2pdf library is loaded');
            
            // Check if there's a timetable to export
            const timetable = document.querySelector('.timetable');
            if (!timetable) {
                console.log('❌ No timetable found');
                alert('Please load a timetable first before exporting to PDF.');
                return;
            }
            console.log('✅ Timetable found');

            // Disable button and show loading state
            exportBtn.disabled = true;
            exportBtn.innerHTML = '⏳ Generating PDF...';
            console.log('📝 Button disabled, generating PDF...');

            // Create a simpler container for PDF export
            const exportContainer = document.createElement('div');
            exportContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 297mm;
                background: white;
                padding: 10mm;
                font-family: Arial, sans-serif;
                color: black;
                z-index: 9999;
                overflow: visible;
            `;

            // Add title and metadata
            const currentDate = new Date().toLocaleDateString();
            const courseText = selectedCourses.size > 0 ? Array.from(selectedCourses).join(', ') : 'All Courses';
            const isCompact = document.getElementById('compactToggle').checked;
            
            console.log('📋 PDF metadata:', { currentDate, courseText, isCompact });
            
            // Build the PDF content as HTML string for better control
            let pdfHTML = `
                <div style="text-align: center; margin-bottom: 15px; border-bottom: 2px solid black; padding-bottom: 8px;">
                    <h1 style="margin: 0; color: black; font-size: 24px; font-weight: bold;">Course Timetable</h1>
                    <p style="margin: 8px 0 4px 0; color: #333; font-size: 14px;">Generated on ${currentDate}</p>
                    <p style="margin: 0; color: #333; font-size: 12px;">Courses: ${courseText} | View: ${isCompact ? 'Compact' : 'Standard'}</p>
                </div>
            `;

            // Build the table manually with inline styles - smaller fonts for better fit
            const fontSize = isCompact ? '9px' : '11px';
            const cellPadding = isCompact ? '3px' : '5px';
            
            pdfHTML += `
                <table style="width: 100%; border-collapse: collapse; font-size: ${fontSize}; margin: 0; page-break-inside: auto;">
                    <thead>
                        <tr>
                            <th style="border: 1px solid black; padding: ${cellPadding}; background: black; color: white; font-weight: bold; text-align: center; font-size: ${fontSize};">Time</th>
                            <th style="border: 1px solid black; padding: ${cellPadding}; background: black; color: white; font-weight: bold; text-align: center; font-size: ${fontSize};">Monday</th>
                            <th style="border: 1px solid black; padding: ${cellPadding}; background: black; color: white; font-weight: bold; text-align: center; font-size: ${fontSize};">Tuesday</th>
                            <th style="border: 1px solid black; padding: ${cellPadding}; background: black; color: white; font-weight: bold; text-align: center; font-size: ${fontSize};">Wednesday</th>
                            <th style="border: 1px solid black; padding: ${cellPadding}; background: black; color: white; font-weight: bold; text-align: center; font-size: ${fontSize};">Thursday</th>
                            <th style="border: 1px solid black; padding: ${cellPadding}; background: black; color: white; font-weight: bold; text-align: center; font-size: ${fontSize};">Friday</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Get current filtered data
            let filteredCourses = [];

            if (selectedCourses.size > 0) {
                filteredCourses = Array.from(selectedCourses);
            } else {
                filteredCourses = allCourses;
            }

            const filteredData = courseData.filter(entry => {
                if (filteredCourses.length === 0 || filteredCourses === allCourses) {
                    return true;
                }
                return filteredCourses.some(filterCourse => {
                    return entry.course === filterCourse || 
                           entry.course.startsWith(filterCourse) || 
                           entry.course.includes(filterCourse);
                });
            });

            // Create schedule grid
            const schedule = {};
            days.forEach(day => {
                schedule[day] = {};
                timeSlots.forEach(time => {
                    schedule[day][time] = [];
                });
            });

            // Populate schedule with course data
            filteredData.forEach(entry => {
                if (schedule[entry.day]) {
                    const startSlot = findTimeSlot(entry.startTime);
                    if (startSlot !== -1) {
                        const durationSlots = Math.ceil(entry.duration / 30);
                        for (let i = 0; i < durationSlots && (startSlot + i) < timeSlots.length; i++) {
                            const timeKey = timeSlots[startSlot + i];
                            if (schedule[entry.day][timeKey]) {
                                const entryWithSpan = {
                                    ...entry,
                                    isFirstSlot: i === 0,
                                    totalSlots: durationSlots,
                                    slotIndex: i
                                };
                                schedule[entry.day][timeKey].push(entryWithSpan);
                            }
                        }
                    }
                }
            });

            // Generate table rows
            timeSlots.forEach((time, index) => {
                // Add page break hint every 20 rows to prevent awkward breaks
                const pageBreakStyle = (index > 0 && index % 20 === 0) ? ' page-break-before: auto;' : '';
                
                pdfHTML += `<tr style="${pageBreakStyle}">`;
                pdfHTML += `<td style="border: 1px solid black; padding: ${cellPadding}; background: #f5f5f5; font-weight: bold; text-align: center; font-size: ${fontSize};">${formatDisplayTime(time)}</td>`;
                
                days.forEach(day => {
                    const classes = schedule[day][time] || [];
                    pdfHTML += `<td style="border: 1px solid black; padding: 2px; text-align: center; vertical-align: middle; height: ${isCompact ? '25px' : '35px'};">`;
                    
                    if (isCompact) {
                        // Compact mode - count ALL classes running during this time slot
                        let lectureCount = 0;
                        let nonLectureCount = 0;
                        const lectureCourses = [];
                        const nonLectureCourses = [];
                        
                        classes.forEach(cls => {
                            // Count ALL classes (both first slots and continuations)
                            if (cls.type === 'lecture') {
                                lectureCount++;
                                if (!lectureCourses.includes(cls.course)) {
                                    lectureCourses.push(cls.course);
                                }
                            } else {
                                nonLectureCount++;
                                if (!nonLectureCourses.includes(cls.course)) {
                                    nonLectureCourses.push(cls.course);
                                }
                            }
                        });
                        
                        if (lectureCount > 0) {
                            const displayText = lectureCount > 1 ? `(${lectureCount})` : '';
                            pdfHTML += `<div style="background: #e74c3c; color: white; margin: 1px; padding: 1px 2px; border-radius: 2px; font-size: ${isCompact ? '7px' : '9px'}; font-weight: bold; line-height: 1.1;">${displayText}</div>`;
                        }
                        
                        if (nonLectureCount > 0) {
                            const displayText = nonLectureCount > 1 ? `(${nonLectureCount})` : '';
                            pdfHTML += `<div style="background: #f1c40f; color: #2c3e50; margin: 1px; padding: 1px 2px; border-radius: 2px; font-size: ${isCompact ? '7px' : '9px'}; font-weight: bold; line-height: 1.1;">${displayText}</div>`;
                        }
                    } else {
                        // Normal mode - show individual courses
                        classes.forEach(cls => {
                            if (cls.isFirstSlot) {
                                const bgColor = cls.type === 'lecture' ? '#e74c3c' : '#f1c40f';
                                const textColor = cls.type === 'lecture' ? 'white' : '#2c3e50';
                                pdfHTML += `<div style="background: ${bgColor}; color: ${textColor}; margin: 1px; padding: 1px 2px; border-radius: 2px; font-size: ${isCompact ? '7px' : '9px'}; font-weight: bold; line-height: 1.1;">`;
                                pdfHTML += `${cls.course}<br><span style="font-size: ${isCompact ? '6px' : '7px'};">${cls.type.toUpperCase()}</span>`;
                                if (cls.location && !isCompact) {
                                    pdfHTML += `<br><span style="font-size: ${isCompact ? '6px' : '7px'};">${cls.location}</span>`;
                                }
                                pdfHTML += '</div>';
                            }
                        });
                    }
                    
                    pdfHTML += '</td>';
                });
                
                pdfHTML += '</tr>';
            });

            pdfHTML += `
                    </tbody>
                </table>
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #ccc; page-break-inside: avoid;">
                    <h3 style="margin: 0 0 6px 0; font-size: 14px;">Legend:</h3>
                    <div style="display: flex; gap: 15px; font-size: 12px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <div style="width: 12px; height: 12px; background: #e74c3c; border-radius: 2px; display: inline-block;"></div>
                            <span>Lectures</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <div style="width: 12px; height: 12px; background: #f1c40f; border-radius: 2px; display: inline-block;"></div>
                            <span>All Others (Tutorials, Labs, Seminars, etc.)</span>
                        </div>
                    </div>
                </div>
            `;

            exportContainer.innerHTML = pdfHTML;
            console.log('📄 PDF content built, length:', pdfHTML.length);

            // Add to DOM temporarily for rendering
            document.body.appendChild(exportContainer);
            console.log('📄 Export container added to DOM');

            // Configure PDF options for multi-page support
            const filename = `timetable_${currentDate.replace(/\//g, '-')}.pdf`;
            const opt = {
                margin: [8, 8, 8, 8],
                filename: filename,
                image: { type: 'jpeg', quality: 0.92 },
                html2canvas: { 
                    scale: 0.75,
                    useCORS: true,
                    allowTaint: false,
                    backgroundColor: '#ffffff',
                    logging: false,
                    width: 1200,
                    height: 2000
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'landscape',
                    putOnlyUsedFonts: true,
                    compress: true
                },
                pagebreak: { mode: 'avoid-all', before: '.page-break' }
            };

            console.log('⚙️ PDF options configured:', opt);
            console.log('🎯 Starting html2pdf generation...');

            // Generate PDF with manual download handling
            html2pdf()
                .set(opt)
                .from(exportContainer)
                .toPdf()
                .get('pdf')
                .then((pdf) => {
                    console.log('✅ PDF generated successfully');
                    console.log('📊 PDF info:', {
                        pages: pdf.internal.getNumberOfPages(),
                        pageSize: pdf.internal.pageSize
                    });
                    
                    // Get the PDF as a blob
                    const pdfBlob = pdf.output('blob');
                    console.log('📦 PDF blob created, size:', pdfBlob.size, 'bytes');
                    
                    // Create download link manually
                    const downloadUrl = URL.createObjectURL(pdfBlob);
                    const downloadLink = document.createElement('a');
                    downloadLink.href = downloadUrl;
                    downloadLink.download = filename;
                    downloadLink.style.display = 'none';
                    
                    // Add to DOM, click, and remove
                    document.body.appendChild(downloadLink);
                    console.log('🔗 Download link created and added to DOM');
                    
                    downloadLink.click();
                    console.log('🖱️ Download link clicked');
                    
                    // Clean up
                    setTimeout(() => {
                        document.body.removeChild(downloadLink);
                        URL.revokeObjectURL(downloadUrl);
                        console.log('🧹 Download link cleaned up');
                    }, 100);
                    
                    return pdf;
                })
                .then(() => {
                    console.log('💾 PDF download initiated');
                    
                    // Reset button
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = '📄 Export as PDF';
                    
                    // Clean up export container
                    if (document.body.contains(exportContainer)) {
                        document.body.removeChild(exportContainer);
                    }
                    console.log('🧹 Export container cleanup completed');
                    
                    showStatus('PDF downloaded successfully! Check your Downloads folder.');
                    console.log('🎉 Export process completed successfully');
                })
                .catch((error) => {
                    console.error('❌ PDF generation failed:', error);
                    console.error('📋 Error details:', {
                        message: error.message,
                        stack: error.stack,
                        name: error.name
                    });
                    
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = '📄 Export as PDF';
                    
                    if (document.body.contains(exportContainer)) {
                        document.body.removeChild(exportContainer);
                    }
                    
                    showStatus(`PDF export failed: ${error.message}`, true);
                    alert(`PDF export failed. Check console for details.\nError: ${error.message}`);
                });
        }

        function updateCourseFilterFromPresets() {
            const presetSelectedCourses = new Set();
            
            // Get all checked presets
            document.querySelectorAll('.preset-checkbox:checked').forEach(checkbox => {
                const presetName = checkbox.dataset.preset;
                const courses = coursePresets[presetName] || [];
                courses.forEach(course => presetSelectedCourses.add(course));
            });
            
            // Get manually selected courses
            const manualSelectedCourses = new Set(selectedCourses);
            
            // Combine preset courses with manually selected courses
            const allSelectedCourses = new Set([...presetSelectedCourses, ...manualSelectedCourses]);
            
            // Update the selected courses
            selectedCourses.clear();
            allSelectedCourses.forEach(course => selectedCourses.add(course));
            
            // Render the bubbles
            renderSelectedCourseBubbles();
            
            // Update the timetable
            filterAndRenderTimetable();
        }

        function handleCompactToggle() {
            const container = document.querySelector('.timetable-container');
            const isCompact = document.getElementById('compactToggle').checked;
            
            if (isCompact) {
                container.classList.add('compact-view');
            } else {
                container.classList.remove('compact-view');
            }
            
            // Re-render the timetable if data exists
            if (courseData.length > 0) {
                filterAndRenderTimetable();
            }
        }

        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${isError ? 'error' : 'success'}">${message}</div>`;
            setTimeout(() => statusDiv.innerHTML = '', 5000);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                console.log('No file selected');
                updateUploadAreaAppearance(null);
                return;
            }

            console.log('File selected:', file.name, 'Size:', file.size);

            if (!file.name.toLowerCase().endsWith('.csv')) {
                showStatus('Please upload a CSV file.', true);
                updateUploadAreaAppearance(null);
                return;
            }

            // Update upload area to show file is being processed
            updateUploadAreaAppearance(file.name);
            showStatus('Reading file...', false);

            const reader = new FileReader();
            reader.onload = function(e) {
                console.log('File loaded, content length:', e.target.result.length);
                try {
                    parseCSV(e.target.result);
                } catch (error) {
                    console.error('Parse error:', error);
                    showStatus(`Error reading file: ${error.message}`, true);
                    updateUploadAreaAppearance(null);
                }
            };
            
            reader.onerror = function(e) {
                console.error('FileReader error:', e);
                showStatus('Error reading file. Please try again.', true);
                updateUploadAreaAppearance(null);
            };
            
            reader.readAsText(file);
        }

        function parseTime(timeStr) {
            if (!timeStr) return null;
            
            // Handle 24-hour format without colon (e.g., "0940", "1410")
            if (/^\d{4}$/.test(timeStr)) {
                let hours = parseInt(timeStr.substring(0, 2));
                let minutes = parseInt(timeStr.substring(2, 4));
                
                // Subtract 10 minutes from the start time
                minutes -= 10;
                if (minutes < 0) {
                    minutes += 60;
                    hours -= 1;
                }
                if (hours < 0) hours = 0;
                
                // Validate hours and minutes
                if (hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59) {
                    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                }
                return null;
            }
            
            // Handle times with colon and optional AM/PM
            const timePattern = /(\d{1,2}):(\d{2})(?:\s*(AM|PM))?/i;
            const match = timeStr.match(timePattern);
            
            if (!match) return null;
            
            let hours = parseInt(match[1]);
            let minutes = parseInt(match[2]);
            const ampm = match[3]?.toLowerCase();
            
            if (ampm === 'pm' && hours !== 12) hours += 12;
            if (ampm === 'am' && hours === 12) hours = 0;
            
            // Subtract 10 minutes from the start time
            minutes -= 10;
            if (minutes < 0) {
                minutes += 60;
                hours -= 1;
            }
            if (hours < 0) hours = 0;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        function addMinutes(timeStr, minutes) {
            const [hours, mins] = timeStr.split(':').map(Number);
            const totalMinutes = hours * 60 + mins + minutes;
            const newHours = Math.floor(totalMinutes / 60);
            const newMins = totalMinutes % 60;
            return `${newHours.toString().padStart(2, '0')}:${newMins.toString().padStart(2, '0')}`;
        }

        function parseDuration(durationStr) {
            if (!durationStr) return 60; // Default to 60 minutes
            
            // Handle HH:MM format (e.g., "01:30", "03:00")
            if (durationStr.includes(':')) {
                const parts = durationStr.split(':');
                if (parts.length === 2) {
                    const hours = parseInt(parts[0]) || 0;
                    const minutes = parseInt(parts[1]) || 0;
                    return hours * 60 + minutes;
                }
            }
            
            // Handle plain number (minutes)
            const numericDuration = parseInt(durationStr);
            if (!isNaN(numericDuration)) {
                return numericDuration;
            }
            
            return 60; // Default fallback
        }

        function normalizeType(type) {
            const typeMap = {
                'lec': 'lecture', 'lecture': 'lecture',
                'tut': 'tutorial', 'tutorial': 'tutorial', 'tutorium': 'tutorial',
                'lab': 'lab', 'laboratory': 'lab',
                'sem': 'seminar', 'seminar': 'seminar',
                'prac': 'practicum', 'practicum': 'practicum',
                'rec': 'tutorial', 'recitation': 'tutorial',
                'dis': 'tutorial', 'discussion': 'tutorial',
                'wor': 'lab', 'workshop': 'lab',
                // Add more mappings based on your "Sec" column values
                '001': 'lecture', '002': 'lecture', '003': 'lecture',
                'l01': 'lecture', 'l02': 'lecture', 'l03': 'lecture',
                't01': 'tutorial', 't02': 'tutorial', 't03': 'tutorial',
                'p01': 'lab', 'p02': 'lab', 'p03': 'lab'
            };
            return typeMap[type.toLowerCase()] || 'lecture';
        }

        function normalizeDay(day) {
            const dayMap = {
                // Single letter codes (your CSV format)
                'm': 'Monday', 'monday': 'Monday',
                't': 'Tuesday', 'tue': 'Tuesday', 'tues': 'Tuesday', 'tuesday': 'Tuesday',
                'w': 'Wednesday', 'wed': 'Wednesday', 'wednesday': 'Wednesday',
                'r': 'Thursday', 'thu': 'Thursday', 'thurs': 'Thursday', 'thursday': 'Thursday',
                'f': 'Friday', 'fri': 'Friday', 'friday': 'Friday'
            };
            return dayMap[day.toLowerCase()] || day;
        }

        function detectColumns(headers) {
            const map = {};
            
            // Map for your specific CSV format
            const exactHeaders = {
                'subject': 'course',           // Subject column
                'sch': 'type',                 // Sch column has the actual type (LEC, TUT, LAB)
                'day': 'day',                  // Day column
                'btime': 'time',               // Begin time
                'duration': 'duration',        // Duration column
                'room': 'location',            // Room column
                'faculty name': 'instructor',   // Faculty Name column
                'crn': 'crn'                   // CRN column
            };

            // Also need course number for full course code
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i].toLowerCase().trim();
                
                if (exactHeaders[header]) {
                    map[exactHeaders[header]] = i;
                } else if (header === 'course number') {
                    map['coursenumber'] = i;
                } else if (header === 'section title') {
                    map['sectiontitle'] = i;
                } else if (header === 'act') {
                    map['actualenrollment'] = i;
                } else if (header === 'max') {
                    map['maxenrollment'] = i;
                }
            }

            return map;
        }

        function parseCSV(csvText) {
            console.log('Starting CSV parse, text length:', csvText.length);
            
            const allLines = csvText.trim().split('\n');
            console.log('Total lines in file:', allLines.length);
            
            // Find the actual header row by looking for "Term Code - Section" or similar patterns
            let headerIndex = -1;
            for (let i = 0; i < allLines.length; i++) {
                const line = allLines[i].toLowerCase();
                if (line.includes('term code') && line.includes('section') && line.includes('subject')) {
                    headerIndex = i;
                    console.log('Found header row at line:', i + 1);
                    break;
                }
            }
            
            if (headerIndex === -1) {
                showStatus('Could not find valid header row in CSV. Please check file format.', true);
                return;
            }
            
            // Skip to the actual data
            const lines = allLines.slice(headerIndex);
            console.log('Processing lines after skipping metadata:', lines.length);
            
            if (lines.length < 2) {
                showStatus('CSV file appears to have no data rows after header.', true);
                return;
            }

            // Show preview of cleaned data
            const preview = lines.slice(0, 3).join('\n');
            console.log('Cleaned CSV Preview:', preview);
            
            document.getElementById('status').innerHTML += 
                `<div class="csv-preview"><strong>CSV Preview (after removing metadata):</strong><br>${preview.replace(/\n/g, '<br>')}</div>`;

            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            console.log('Headers found:', headers.length);
            console.log('Headers:', headers);
            
            const rows = lines.slice(1);
            console.log('Data rows:', rows.length);

            // Try to auto-detect column positions
            const columnMap = detectColumns(headers);
            console.log('Column mapping:', columnMap);
            
            if (!columnMap.course || !columnMap.day || !columnMap.time || !columnMap.crn) {
                const missing = [];
                if (!columnMap.course) missing.push('Subject');
                if (!columnMap.day) missing.push('Day');
                if (!columnMap.time) missing.push('BTime');
                if (!columnMap.crn) missing.push('CRN');
                
                showStatus(`Could not detect required columns. Missing: ${missing.join(', ')}. Found columns: ${Object.keys(columnMap).join(', ')}`, true);
                return;
            }

            courseData = [];
            const uniqueCourses = new Set();
            let processedRows = 0;
            let skippedRows = 0;

            rows.forEach((row, index) => {
                const cells = parseCSVRow(row);
                if (cells.length < headers.length) {
                    skippedRows++;
                    return;
                }

                try {
                    const subject = cells[columnMap.course]?.trim();
                    const courseNumber = cells[columnMap.coursenumber]?.trim();
                    const sectionTitle = cells[columnMap.sectiontitle]?.trim();
                    const type = cells[columnMap.type]?.trim() || 'LEC';
                    const day = cells[columnMap.day]?.trim();
                    const timeStr = cells[columnMap.time]?.trim();
                    const durationStr = cells[columnMap.duration]?.trim();
                    const duration = parseDuration(durationStr);
                    const location = cells[columnMap.location]?.trim() || '';
                    const instructor = cells[columnMap.instructor]?.trim() || '';
                    const crn = cells[columnMap.crn]?.trim() || '';

                    // Debug first few rows
                    if (index < 5) {
                        console.log(`Row ${index + 2}:`, {
                            subject, courseNumber, crn, type: `"${type}"`, day, timeStr, 
                            durationStr: `"${durationStr}"`, duration, location, instructor
                        });
                    }

                    // Skip if essential fields are missing
                    if (!subject || !day || !timeStr || !crn || day.toLowerCase() === 'tba') {
                        skippedRows++;
                        return;
                    }

                    // Create full course code
                    const courseCode = courseNumber ? `${subject}${courseNumber}` : subject;

                    const startTime = parseTime(timeStr);
                    if (!startTime) {
                        console.log(`Could not parse time: "${timeStr}" on row ${index + 2}`);
                        skippedRows++;
                        return;
                    }

                    const endTime = addMinutes(startTime, duration);
                    
                    // Extract actual enrollment from 'Act' column
                    const actualEnrollmentStr = cells[columnMap.actualenrollment]?.trim() || '0';
                    const actualEnrollment = parseInt(actualEnrollmentStr) || 0;

                    // Extract max enrollment from 'Max' column
                    const maxEnrollmentStr = cells[columnMap.maxenrollment]?.trim() || '0';
                    const maxEnrollment = parseInt(maxEnrollmentStr) || 0;

                    courseData.push({
                        course: courseCode.toUpperCase(),
                        crn: crn,
                        type: normalizeType(type),
                        day: normalizeDay(day),
                        startTime,
                        endTime,
                        duration,
                        location,
                        instructor,
                        sectionTitle: sectionTitle || '',
                        actualEnrollment,
                        maxEnrollment
                    });

                    uniqueCourses.add(courseCode.toUpperCase());
                    processedRows++;
                } catch (error) {
                    console.warn(`Error parsing row ${index + 2}:`, error);
                    skippedRows++;
                }
            });

            allCourses = Array.from(uniqueCourses).sort();
            
            console.log(`Processed: ${processedRows}, Skipped: ${skippedRows}, Unique courses: ${allCourses.length}`);
            console.log('All courses found:', allCourses);
            console.log('Sample course data (first 5):', courseData.slice(0, 5));
            
            if (courseData.length === 0) {
                showStatus('No valid course data found. Please check your CSV format and data.', true);
                updateUploadAreaAppearance(null);
                return;
            }

            showStatus(`Successfully loaded ${courseData.length} course entries for ${allCourses.length} courses. (Processed: ${processedRows}, Skipped: ${skippedRows})`);
            filterAndRenderTimetable();
        }

        function parseCSVRow(row) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < row.length; i++) {
                const char = row[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result.map(cell => cell.replace(/^"|"$/g, ''));
        }

        function filterAndRenderTimetable() {
            let filteredData = [];

            console.log('Selected courses:', Array.from(selectedCourses));
            console.log('Available courses:', allCourses.slice(0, 10), '... and', allCourses.length - 10, 'more');

            if (selectedCourses.size > 0) {
                filteredData = courseData.filter(entry => {
                    return selectedCourses.has(entry.course);
                });
            } else {
                filteredData = courseData;
                console.log('Using all courses (no filter)');
            }

            console.log('Filtered data length:', filteredData.length);
            if (filteredData.length > 0) {
                console.log('Sample filtered courses:', [...new Set(filteredData.map(d => d.course))].slice(0, 5));
            }

            renderTimetable(filteredData);
            
            // Show workshop scheduler if we have data
            if (courseData.length > 0) {
                document.getElementById('workshopScheduler').style.display = 'block';
                populatePriorityCourses();
            }
        }

        function renderTimetable(data) {
            console.log('Rendering timetable with data length:', data.length);
            
            const container = document.querySelector('.timetable-container');
            const noDataDiv = document.getElementById('noData');

            if (data.length === 0) {
                console.log('No data to render');
                container.innerHTML = '<div class="no-data"><h3>📋 No courses match your filter</h3><p>Try adjusting your course filter or upload a different CSV file.</p></div>';
                return;
            }

            if (noDataDiv) noDataDiv.style.display = 'none';

            console.log('Building schedule grid...');

            // Create timetable structure
            let html = '<table class="timetable"><thead><tr>';
            html += '<th class="time-header">Time</th>';
            
            days.forEach(day => {
                html += `<th class="day-header">${day}</th>`;
            });
            
            html += '</tr></thead><tbody>';

            // Create schedule grid
            const schedule = {};
            days.forEach(day => {
                schedule[day] = {};
                timeSlots.forEach(time => {
                    schedule[day][time] = [];
                });
            });

            // Populate schedule with course data
            let placedCourses = 0;
            data.forEach(entry => {
                console.log('Processing entry:', entry);
                
                if (schedule[entry.day]) {
                    const startSlot = findTimeSlot(entry.startTime);
                    console.log(`Looking for time slot for ${entry.startTime}, found slot index: ${startSlot}`);
                    
                    if (startSlot !== -1) {
                        // Calculate how many 15-minute slots this class spans
                        const durationSlots = Math.ceil(entry.duration / 15);
                        console.log(`Class duration: ${entry.duration} minutes = ${durationSlots} slots`);
                        
                        // Place the class in all time slots it spans
                        for (let i = 0; i < durationSlots && (startSlot + i) < timeSlots.length; i++) {
                            const timeKey = timeSlots[startSlot + i];
                            console.log(`Placing ${entry.course} in ${entry.day} at ${timeKey} (slot ${i + 1} of ${durationSlots})`);
                            
                            if (schedule[entry.day][timeKey]) {
                                // Create a copy of the entry with span info for styling
                                const entryWithSpan = {
                                    ...entry,
                                    isFirstSlot: i === 0,
                                    totalSlots: durationSlots,
                                    slotIndex: i
                                };
                                schedule[entry.day][timeKey].push(entryWithSpan);
                                if (i === 0) placedCourses++; // Only count once per class
                            }
                        }
                    } else {
                        console.log(`Could not find time slot for ${entry.startTime}`);
                    }
                } else {
                    console.log(`Day ${entry.day} not found in schedule`);
                }
            });

            console.log(`Placed ${placedCourses} courses in schedule`);

            // Generate table rows
            timeSlots.forEach(time => {
                html += '<tr>';
                html += `<td class="time-slot">${formatDisplayTime(time)}</td>`;
                
                days.forEach(day => {
                    const classes = schedule[day][time] || [];
                    html += '<td class="schedule-cell">';
                    
                    const isCompact = document.getElementById('compactToggle').checked;
                    
                    if (isCompact) {
                        // In compact mode, count unique courses running during this time slot
                        const lectureCoursesSet = new Set();
                        const nonLectureCoursesSet = new Set();
                        
                        classes.forEach(cls => {
                            // Count unique courses running at this time
                            if (cls.type === 'lecture') {
                                lectureCoursesSet.add(cls.course);
                            } else {
                                nonLectureCoursesSet.add(cls.course);
                            }
                        });
                        
                        const lectureCount = lectureCoursesSet.size;
                        const nonLectureCount = nonLectureCoursesSet.size;
                        
                        // Render lecture group (red) - only if there are lectures
                        if (lectureCount > 0) {
                            const displayText = lectureCount > 1 ? `(${lectureCount})` : '';
                            const tooltipCourses = Array.from(lectureCoursesSet).join(', ');
                            
                            html += `<div class="class-block lecture" title="Lectures: ${tooltipCourses}">`;
                            html += displayText;
                            html += '</div>';
                        }
                        
                        // Render ALL non-lectures as one group (yellow) - only if there are non-lectures
                        if (nonLectureCount > 0) {
                            const displayText = nonLectureCount > 1 ? `(${nonLectureCount})` : '';
                            const tooltipCourses = Array.from(nonLectureCoursesSet).join(', ');
                            
                            html += `<div class="class-block tutorial" title="Non-lectures: ${tooltipCourses}">`;
                            html += displayText;
                            html += '</div>';
                        }
                        
                    } else {
                        // Normal mode - show individual courses
                        classes.forEach(cls => {
                            const typeClass = cls.type;
                            
                            // Only show the full block for the first slot of multi-slot classes
                            if (!cls.isFirstSlot) {
                                // For continuation slots, show a subtle continuation indicator
                                html += `<div class="class-block ${typeClass} continuation">`;
                                html += `<span class="class-info">↑ ${cls.course}</span>`;
                            } else {
                                // For the first slot, show full info WITHOUT adjusting height for spanning
                                html += `<div class="class-block ${typeClass}" title="${cls.course} - ${cls.type}${cls.sectionTitle ? ': ' + cls.sectionTitle : ''}${cls.location ? ' at ' + cls.location : ''}${cls.instructor ? ' with ' + cls.instructor : ''}">`;
                                html += `<div>${cls.course}</div>`;
                                html += `<span class="class-info">${cls.type.toUpperCase()}</span>`;
                                
                                if (cls.location) {
                                    html += `<span class="class-info">${cls.location}</span>`;
                                }
                                // Always show duration, subtract 10 minutes for display
                                const displayDuration = Math.max(cls.duration - 10, 0);
                                html += `<span class="class-info">${displayDuration}min</span>`;
                                
                                // Only show instructor for lectures (red boxes)
                                if (cls.type === 'lecture') {
                                    // Format instructor name as "F LAST" or "NO INSTR"
                                    // Handle "LAST, FIRST" format from CSV
                                    let instructorDisplay = "NO INSTR";
                                    if (cls.instructor && cls.instructor.trim()) {
                                        const instructorStr = cls.instructor.trim();
                                        if (instructorStr.includes(',')) {
                                            // Handle "LAST, FIRST" format
                                            const parts = instructorStr.split(',').map(p => p.trim());
                                            if (parts.length >= 2 && parts[1]) {
                                                const lastName = parts[0];
                                                const firstNameInitial = parts[1].charAt(0);
                                                instructorDisplay = `${firstNameInitial} ${lastName}`.toUpperCase();
                                            } else {
                                                instructorDisplay = parts[0].toUpperCase();
                                            }
                                        } else {
                                            // Handle single name or "FIRST LAST" format
                                            const nameParts = instructorStr.split(/\s+/);
                                            if (nameParts.length >= 2) {
                                                const firstNameInitial = nameParts[0].charAt(0);
                                                const lastName = nameParts[nameParts.length - 1];
                                                instructorDisplay = `${firstNameInitial} ${lastName}`.toUpperCase();
                                            } else {
                                                instructorDisplay = nameParts[0].toUpperCase();
                                            }
                                        }
                                    }
                                    html += `<span class="class-info">${instructorDisplay}</span>`;
                                }
                            }
                            html += '</div>';
                        });
                    }
                    
                    html += '</td>';
                });
                
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
            
            console.log('Timetable rendered successfully');
        }

        function findTimeSlot(time) {
            return timeSlots.findIndex(slot => slot === time || slot >= time);
        }

        function formatDisplayTime(time) {
            const [hours, minutes] = time.split(':').map(Number);
            const period = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours);
            return `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
        }
    </script>
</body>
</html>

